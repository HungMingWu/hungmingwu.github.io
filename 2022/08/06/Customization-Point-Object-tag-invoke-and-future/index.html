<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="namespace由於繼承自C語言，所以會遇到像這樣的問題 123456&#x2F;&#x2F; my_std.hvoid foo(int);void bar(void);&#x2F;&#x2F; other_lib.hint foo(void);int baz(int, int); 來自於不同的Library，且提供不同的實作，在使用上會出現一些問題而C語言時代的解法就是對Function Name加料 123456&#x2F;&#x2F; my_std">
<meta property="og:type" content="article">
<meta property="og:title" content="Customization Point Object, tag_invoke and future">
<meta property="og:url" content="http://yoursite.com/2022/08/06/Customization-Point-Object-tag-invoke-and-future/index.html">
<meta property="og:site_name" content="第十三號艦隊">
<meta property="og:description" content="namespace由於繼承自C語言，所以會遇到像這樣的問題 123456&#x2F;&#x2F; my_std.hvoid foo(int);void bar(void);&#x2F;&#x2F; other_lib.hint foo(void);int baz(int, int); 來自於不同的Library，且提供不同的實作，在使用上會出現一些問題而C語言時代的解法就是對Function Name加料 123456&#x2F;&#x2F; my_std">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-08-06T10:57:06.000Z">
<meta property="article:modified_time" content="2025-10-06T01:47:17.628Z">
<meta property="article:author" content="HungMingWu">
<meta property="article:tag" content="C++">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/2022/08/06/Customization-Point-Object-tag-invoke-and-future/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Customization Point Object, tag_invoke and future | 第十三號艦隊</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">第十三號艦隊</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/HungMingWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/08/06/Customization-Point-Object-tag-invoke-and-future/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Customization Point Object, tag_invoke and future
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-06 10:57:06" itemprop="dateCreated datePublished" datetime="2022-08-06T10:57:06+00:00">2022-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>由於繼承自C語言，所以會遇到像這樣的問題</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_std.h</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// other_lib.h</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">baz</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>來自於不同的Library，且提供不同的實作，在使用上會出現一些問題<br>而C語言時代的解法就是對Function Name加料</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_std.h</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_std_foo</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">my_std_bar</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="comment">// other_lib.h</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">other_lib_foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">other_lib_baz</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>而C++做的事情差不多，用namespace隔開</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// my_std.h</span></span><br><span class="line"><span class="keyword">namespace</span> my_std &#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// other_lib.h</span></span><br><span class="line"><span class="keyword">namespace</span> other_lib &#123;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">baz</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">int</span>)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ADL"><a href="#ADL" class="headerlink" title="ADL"></a>ADL</h3><p>全名是<strong>Argument-Dependent Lookup</strong><br>只要有一個參數在函數的命名空間內，在使用的時候就不用加namespace prefix<br>在ADL只關心函數，<strong>不包含Function Object</strong>，這點在之後會用到</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> A</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Empty</span> &#123;</span>&#125;;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(Empty, <span class="keyword">int</span>)</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    A::foo(<span class="number">2</span>);</span><br><span class="line">    bar(A::Empty&#123;&#125;, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="number">1</span>; <span class="comment">// operator&lt;&lt; (std::cout, 1) Due to ADL</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果沒有ADL，最後那行只能這樣寫了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p>應該沒人會喜歡</p>
<h3 id="Example-for-std-swap"><a href="#Example-for-std-swap" class="headerlink" title="Example for std::swap"></a>Example for std::swap</h3><p>這是拓展問題的最好範例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="built_in">std</span> &#123;</span><br><span class="line">	<span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(T&amp; a, T&amp; b)</span> </span>&#123; </span><br><span class="line">		<span class="function">T <span class="title">temp</span><span class="params">(a)</span></span>; </span><br><span class="line">		a = b; </span><br><span class="line">		b = temp; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我們要對自己的class做swap動作時，該怎麼做</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> My &#123;</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line">	<span class="keyword">public</span>:</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(A&amp;)</span> </span>&#123;&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直覺的寫法可以這樣做</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">```cpp</span><br><span class="line"><span class="keyword">namespace</span> <span class="built_in">std</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span>&lt;&gt;</span><br><span class="line">    <span class="keyword">void</span> swap&lt;::My::A&gt;(::My::A&amp; a, ::My::A&amp; b) &#123;a.swap(b);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這樣寫是Undefined Beahvior<br>而另外一種做法是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;&gt;</span><br><span class="line"><span class="keyword">void</span> <span class="built_in">std</span>::swap&lt;My::A&gt;(My::A&amp; a, My::A&amp; b) &#123; a.swap(b); &#125;</span><br></pre></td></tr></table></figure>
<p>不過如果是<code>My::A&lt;T&gt;</code>的話就不管用了<br>而比較常用的手法，就是利用ADL</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(...)</span></span>; <span class="comment">// 1 </span></span><br><span class="line"><span class="keyword">namespace</span> My &#123; </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">A</span>&#123;</span>&#125;; </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">const</span> A&amp;)</span></span>; <span class="comment">// 2 </span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> Code &#123; </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">int</span>)</span></span>; <span class="comment">// 3 </span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">use</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		::My::A a;</span><br><span class="line">		fun(a); <span class="comment">// HERE </span></span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>呼叫的<code>foo(a)</code>時，會考慮2和3，1是因為在Code的namespace已經找到一個fun了，部會在往上層的scope去尋找<br>利用<code>ADL two-step</code>的手法來拓展我們的<code>std::swap</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;utility&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> My</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">A</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">friend</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(A&amp; a, A&amp; b)</span> </span>&#123; a.swap(b); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">B</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">friend</span> <span class="keyword">void</span> <span class="title">swap</span><span class="params">(B&amp; a, B&amp; b)</span> </span>&#123; a.swap(b); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> Code</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">use</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">        ::My::A a1, a2;</span><br><span class="line">        swap(a1, a2); <span class="comment">// HERE #1</span></span><br><span class="line">        ::My::B&lt;<span class="keyword">int</span>&gt; b1, b2;</span><br><span class="line">        swap(b1, b2); <span class="comment">// HERE #2</span></span><br><span class="line">        <span class="keyword">int</span> i1, i2;</span><br><span class="line">        swap(i1, i2); <span class="comment">// NOPE</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在這個範例當中，呼叫swap的時候沒加上namespace，而讓<code>std::swap</code>注入當今的Scope下，如果可以透過ADL找到對應的函數，則用特化版的函數，不然就用原先的<code>std::swap</code>做預設值</p>
<h3 id="Drawback-on-ADL-two-step"><a href="#Drawback-on-ADL-two-step" class="headerlink" title="Drawback on ADL two-step"></a>Drawback on ADL two-step</h3><p>最大的問題在於</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">swap(a1, a2);</span><br></pre></td></tr></table></figure>
<p>可能一不小心就寫成</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::swap(a1, a2);</span><br></pre></td></tr></table></figure>
<p>不會報錯，頂多是效能差<br>另外一個比較大的問題是這個</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> __my_std_impl</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="keyword">auto</span> __distance_impl(T first, T last) &#123;<span class="comment">/* ... */</span>&#125;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="function"><span class="keyword">auto</span> <span class="title">distance</span><span class="params">(T first, T last)</span> </span>&#123;<span class="keyword">return</span> __distance_impl(first, last);&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">incomplete</span>;</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="class"><span class="keyword">struct</span> <span class="title">box</span> &#123;</span>T value;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">use</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    incomplete* i = <span class="literal">nullptr</span>; <span class="comment">// fine</span></span><br><span class="line">    __my_std_impl::distance(i, i); <span class="comment">// fine</span></span><br><span class="line">    box&lt;incomplete&gt;* b = <span class="literal">nullptr</span>; <span class="comment">// fine</span></span><br><span class="line">    __my_std_impl::distance(b, b); <span class="comment">// !!!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>__my_std_impl::distance(b, b)</code>的地方會報錯<br>原因在於<code>__distance_impl</code>階段會進行ADL動作，在box的定義上尋找是否有<code>__distance_impl</code>的函數，因找到incomplete value，故報錯<br>一種可能的解法就是加上namespace</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">distance</span><span class="params">(T first, T last)</span> </span>&#123;<span class="keyword">return</span> __my_std_impl::__distance_impl(first, last);&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Customization-Point-Object"><a href="#Customization-Point-Object" class="headerlink" title="Customization Point Object"></a>Customization Point Object</h3><p>兩階段ADL的最大問題就是容易誤用<br>因此叫Standlard library來幫你做這件事<br>其中最簡單的CPO就長這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="built_in">std</span>::ranges &#123;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">constexpr</span> swap = [](<span class="keyword">auto</span>&amp; a, <span class="keyword">auto</span>&amp; b) &#123; </span><br><span class="line">		<span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">		swap(a, b); </span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裡的swap是個constexpr object，而不是個function，不過他是一個functor，因此可以適用於所有std::swap的環境下<br>CPO還有一個優勢，它是一個object，所以它能夠這樣用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">some_ranges | views::transform(ranges::begin)</span><br></pre></td></tr></table></figure>
<p>而</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">some_ranges | views::transform(<span class="built_in">std</span>::begin)</span><br></pre></td></tr></table></figure>
<p>這樣用不合法，因為它是個template function</p>
<h3 id="Niebloids"><a href="#Niebloids" class="headerlink" title="Niebloids"></a>Niebloids</h3><p>Niebloids是要解決另外一個問題，去除掉不想要的ADL candicate<br>禁用的方法就是讓它成為CPO<br>以下是StackOverflow的範例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> mystd</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">B</span>&#123;</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span>&#125;;</span><br><span class="line">    <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(T &amp;a, T &amp;b)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"mystd::swap\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> sx</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">namespace</span> impl &#123;</span><br><span class="line">       <span class="comment">//our functor, the niebloid</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> __<span class="title">swap</span> &#123;</span></span><br><span class="line">            <span class="keyword">template</span>&lt;<span class="keyword">typename</span> R, <span class="keyword">typename</span> = <span class="built_in">std</span>::<span class="keyword">enable_if_t</span>&lt; <span class="built_in">std</span>::is_same&lt;R, mystd::A&gt;::value &gt;  &gt;</span><br><span class="line">            <span class="keyword">void</span> <span class="keyword">operator</span>()(R &amp;a, R &amp;b) <span class="keyword">const</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"in sx::swap()\n"</span>;</span><br><span class="line">                <span class="comment">// swap(a, b); </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">inline</span> <span class="keyword">constexpr</span> impl::__swap swap&#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mystd::B a, b;</span><br><span class="line">    swap(a, b); <span class="comment">// calls mystd::swap()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> sx;</span><br><span class="line">    mystd::A c, d;</span><br><span class="line">    swap(c, d); <span class="comment">//No ADL!, calls sx::swap!</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果找到的是function object，則不會使用ADL</p>
<h3 id="tag-invoke"><a href="#tag-invoke" class="headerlink" title="tag_invoke"></a>tag_invoke</h3><p>根據libunifex裡面的描述，一樣是透過ADL，要解決以下兩個問題</p>
<blockquote>
<ol>
<li>Each one internally dispatches via ADL to a free function of the same name, which has the effect of globally reserving that identifier (within some constraints). Two independent libraries that pick the same name for an ADL customization point still risk collision.  </li>
<li>There is occasionally a need to write wrapper types that ought to be transparent to customization. (Type-erasing wrappers are one such example.) With C++20’s CPOs, there is no way to generically forward customizations through the transparent wrap<br>比較大的問題是第一點，由於透過ADL尋找函數，所以每個namespace下都需要將函數名稱當作保留字</li>
</ol>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="built_in">std</span>::range &#123;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">constexpr</span> swap = [](<span class="keyword">auto</span>&amp; a, <span class="keyword">auto</span>&amp; b) &#123; </span><br><span class="line">		<span class="keyword">using</span> <span class="built_in">std</span>::swap;</span><br><span class="line">		swap(a, b); </span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(...)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">nameapce B &#123;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">swap</span><span class="params">(....)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是你用了swap當CPO之後，其他地方都要保留swap當作保留字不能使用，tag_invoke就是為了這點而生的<br>參考C++11 tag_invoke的實作 duck_invoke</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bfg/tag_invoke.h&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> compute &#123;</span><br><span class="line">BFG_TAG_INVOKE_DEF(formula);</span><br><span class="line">&#125; <span class="comment">// namespace compute</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Compute&gt;</span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">do_compute</span><span class="params">(<span class="keyword">const</span> Compute &amp; c, <span class="keyword">float</span> a, <span class="keyword">float</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> compute::formula(c, a, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">custom_compute</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">friend</span> <span class="keyword">float</span></span><br><span class="line">		tag_invoke(compute::<span class="keyword">formula_t</span>, <span class="keyword">const</span> custom_compute &amp;, <span class="keyword">float</span> a, <span class="keyword">float</span> b)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> a * b;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	do_compute(custom_compute&#123;&#125;, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主要的作法是</p>
<ul>
<li>需要一個CPO參數，以上的範例是<code>formula</code></li>
<li>只需要一個tag_invoke function，不過可以Overloading，對不同的CPOj做不同的處理<br>不過tag_invoke製造了其他問題，難以理解且囉嗦</li>
</ul>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>由於Executors跳票了，所以tag_invoke也不一定是最終解決方案<br>目前有其他提案，不過會不會被接受也在未定之天<br>詳細可以找找P2547R0來研究</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.zhihu.com/question/518132411" target="_blank" rel="noopener">如何理解 C++ 中的 定制点对象 这一概念？为什么要这样设计？</a><br><a href="https://zhuanlan.zhihu.com/p/431032074" target="_blank" rel="noopener">c++ execution 与 coroutine （一) : CPO与tag_invoke</a><br><a href="https://zhuanlan.zhihu.com/p/532859426" target="_blank" rel="noopener">C++特殊定制：揭秘cpo与tag_invoke！</a><br><a href="https://www.boost.org/doc/libs/1_77_0/libs/json/doc/html/json/dom/conversion.html#json.dom.conversion.customization_points" target="_blank" rel="noopener">Customization Points</a><br><a href="https://en.cppreference.com/w/cpp/language/adl" target="_blank" rel="noopener">Argument-dependent lookup - cppreference.com</a><br><a href="https://brevzin.github.io/c++/2020/12/01/tag-invoke/" target="_blank" rel="noopener">Why tag_invoke is not the solution I want (brevzin.github.io)</a><br><a href="https://stackoverflow.com/questions/62928396/what-is-a-niebloid" target="_blank" rel="noopener">What is a niebloid?</a><br><a href="https://zhuanlan.zhihu.com/p/374440385" target="_blank" rel="noopener">ADL，Concepts与扩展C++类库带来的思考</a><br><a href="https://www.bfgroup.xyz/duck_invoke/" target="_blank" rel="noopener">Duck Invoke — tag_invoke for C++11</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/06/04/Macro-in-Rust/" rel="prev" title="Macro in Rust">
      <i class="fa fa-chevron-left"></i> Macro in Rust
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/09/09/How-to-write-comparsion-operator-for-custom-type-in-C/" rel="next" title="How to write comparsion operator for custom type in C++">
      How to write comparsion operator for custom type in C++ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#namespace"><span class="nav-number">1.</span> <span class="nav-text">namespace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ADL"><span class="nav-number">2.</span> <span class="nav-text">ADL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example-for-std-swap"><span class="nav-number">3.</span> <span class="nav-text">Example for std::swap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Drawback-on-ADL-two-step"><span class="nav-number">4.</span> <span class="nav-text">Drawback on ADL two-step</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Customization-Point-Object"><span class="nav-number">5.</span> <span class="nav-text">Customization Point Object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Niebloids"><span class="nav-number">6.</span> <span class="nav-text">Niebloids</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tag-invoke"><span class="nav-number">7.</span> <span class="nav-text">tag_invoke</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Future"><span class="nav-number">8.</span> <span class="nav-text">Future</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Reference"><span class="nav-number">9.</span> <span class="nav-text">Reference</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">HungMingWu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">258</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HungMingWu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
