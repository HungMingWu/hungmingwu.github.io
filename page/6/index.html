<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="第十三號艦隊">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="第十三號艦隊">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="HungMingWu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>第十三號艦隊</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">第十三號艦隊</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/HungMingWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/08/2019-09-08-method-extension-in-c/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/08/2019-09-08-method-extension-in-c/" class="post-title-link" itemprop="url">Extension Method in C++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-09-08 13:31:00" itemprop="dateCreated datePublished" datetime="2019-09-08T13:31:00+00:00">2019-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="從C-Extension-Method說起"><a href="#從C-Extension-Method說起" class="headerlink" title="從C# Extension Method說起"></a>從C# Extension Method說起</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">static class StringUtilities</span><br><span class="line">&#123;</span><br><span class="line">   public static int WordCount(this string text)</span><br><span class="line">   &#123;</span><br><span class="line">      return text.Split(new char[] &#123; &#39; &#39; &#125;, StringSplitOptions.RemoveEmptyEntries).Length;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">var text &#x3D; &quot;This is an example&quot;;</span><br><span class="line">var count &#x3D; text.WordCount();</span><br></pre></td></tr></table></figure>
<p>將一個Method綁在已有的type之上<br>在C++有類似的提案，叫做UFCS<br>不過提案會不會過還不知道，但是可以用目前的技術模擬<br>以下從Reddit看來的兩種方式，寫下自己的看法</p>
<h3 id="Ver-1"><a href="#Ver-1" class="headerlink" title="Ver 1"></a>Ver 1</h3><p>使用CRTP技巧來達成</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// One way to emulate UFCS in standard C++.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A CRTP class that forwards .call&lt;F&gt;(...) to F::function(*this, ...)</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">uniform_call_syntax</span> &#123;</span></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> F, <span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">constexpr</span> <span class="keyword">auto</span> <span class="title">call</span><span class="params">(Args... args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> F::function(<span class="keyword">static_cast</span>&lt;T&amp;&gt;(*<span class="keyword">this</span>), args...);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Usage:</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_type</span> :</span> <span class="keyword">public</span> uniform_call_syntax&lt;my_type&gt; &#123;</span><br><span class="line">    <span class="keyword">int</span> value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">set_value</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> my_type&amp; <span class="title">function</span><span class="params">(my_type&amp; o, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        o.value = i;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">add_value</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> my_type&amp; <span class="title">function</span><span class="params">(my_type&amp; o, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        o.value += i;</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">get_value</span> &#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">function</span><span class="params">(<span class="keyword">const</span> my_type&amp; o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> o.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    my_type obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line">        .call&lt;set_value&gt;(<span class="number">10</span>)</span><br><span class="line">        .call&lt;add_value&gt;(<span class="number">20</span>)</span><br><span class="line">        .call&lt;get_value&gt;();  <span class="comment">// returns 30.</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>作法顯而易見，每個需要UFCS功能的都需要繼承uniform_call_syntax<T>，然後每個Externsion method都需要有同樣的function name<br>缺點也顯而易見，要有這功能就需要繼承，有些type是不允許修改的</p>
<h3 id="Ver-2"><a href="#Ver-2" class="headerlink" title="Ver 2"></a>Ver 2</h3><p>版本二需要C++14以上的標準</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Same as Haskell's infix operator `&amp;` or F#'s operator `|&gt;`</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> Arg, <span class="keyword">typename</span> F&gt;</span><br><span class="line"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="keyword">operator</span> % (Arg&amp;&amp; arg, F&amp;&amp; fn)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">std</span>::forward&lt;F&gt;(fn)(<span class="built_in">std</span>::forward&lt;Arg&gt;(arg));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> my</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">auto</span> <span class="built_in">tolower</span> = []</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> [](<span class="keyword">auto</span>&amp;&amp; s) -&gt; <span class="keyword">decltype</span>(<span class="keyword">auto</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">auto</span>&amp; c : s) &#123;</span><br><span class="line">				c = (<span class="string">'A'</span> &lt;= c &amp;&amp; c &lt;= <span class="string">'Z'</span>) ? c - (<span class="string">'Z'</span> - <span class="string">'z'</span>) : c;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">decltype</span>(s)(s);</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">auto</span> <span class="title">append</span><span class="params">(<span class="keyword">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; what)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">return</span> [&amp;](<span class="keyword">auto</span>&amp;&amp; s) -&gt; <span class="keyword">decltype</span>(<span class="keyword">auto</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			s += what;</span><br><span class="line">			<span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="string">"is-lvalue-reference:"</span> &lt;&lt; <span class="built_in">std</span>::is_lvalue_reference&lt;<span class="keyword">decltype</span>(s)&gt;::value &lt;&lt; <span class="string">";"</span> &lt;&lt; s &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">std</span>::forward&lt;<span class="keyword">decltype</span>(s)&gt;(s);</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// as rvalue-references</span></span><br><span class="line">	<span class="keyword">auto</span> s1 = <span class="built_in">std</span>::<span class="built_in">string</span>&#123; <span class="string">"HELLO,"</span> &#125;</span><br><span class="line">		% my::<span class="built_in">tolower</span>()</span><br><span class="line">		% my::append(<span class="string">" world"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// as lvalue-references</span></span><br><span class="line">	<span class="keyword">auto</span> s2 = <span class="built_in">std</span>::<span class="built_in">string</span>&#123; <span class="string">"GOODOBYE,"</span> &#125;;</span><br><span class="line">	s2% my::<span class="built_in">tolower</span>()</span><br><span class="line">		% my::append(<span class="string">" cruel world."</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; s1 &lt;&lt; <span class="string">"\n"</span> &lt;&lt; s2 &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起來很美，很像Functional Programming的Pipe觀念<br>不過對Programmer的要求比較高，至少要有FP的基本觀念才比較容易理解</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/09/2019-08-09-capture-this-and-s-this-this-in-c-lambda/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/09/2019-08-09-capture-this-and-s-this-this-in-c-lambda/" class="post-title-link" itemprop="url">Capture this and *this in C++ Lambda</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-09 01:06:00" itemprop="dateCreated datePublished" datetime="2019-08-09T01:06:00+00:00">2019-08-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>看了C++17的文章之後，還是搞不太清楚兩者的差異，於是自己寫程式驗證一下</p>
<h3 id="Capture-this"><a href="#Capture-this" class="headerlink" title="Capture this"></a>Capture this</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line">        Obj(<span class="keyword">int</span> value) : v(<span class="built_in">std</span>::make_unique&lt;<span class="keyword">int</span>&gt;(value)) &#123;&#125;</span><br><span class="line">        ~Obj() &#123; <span class="built_in">printf</span>(<span class="string">"Obj have been destroyed\n"</span>); &#125;</span><br><span class="line">        Obj(<span class="keyword">const</span> Obj&amp; o) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Copy constructor invoked\n"</span>);</span><br><span class="line">                v = <span class="built_in">std</span>::make_unique&lt;<span class="keyword">int</span>&gt;(*o.v);</span><br><span class="line">        &#125;</span><br><span class="line">		Obj(Obj&amp;&amp; o) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"Move constructor invoke\n"</span>);</span><br><span class="line">                v = <span class="built_in">std</span>::move(o.v);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">auto</span> <span class="title">test</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> [<span class="keyword">this</span>] &#123; <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, *v); &#125;; &#125;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> test = Obj(<span class="number">123</span>).test();</span><br><span class="line">        test();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很不意外的，Crash掉了<br>如果我們把呼叫改成<code>Obj(123).test()()</code>，Obj的Lifetime就跟執行時間一樣長了，可以正常執行</p>
<h3 id="Capture-this-1"><a href="#Capture-this-1" class="headerlink" title="Capture *this"></a>Capture *this</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line">        <span class="function"><span class="keyword">auto</span> <span class="title">test</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> [*<span class="keyword">this</span>] &#123; <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, *v); &#125;; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>跟上面一樣，只是修改了capture this的方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Copy constructor invoked</span><br><span class="line">Obj have been destroyed</span><br><span class="line">123</span><br><span class="line">Obj have been destroyed</span><br></pre></td></tr></table></figure>
<p>由此可見他會呼叫Copy construtor，然後摧毀了原先的Obj，lambda中的this指的就是Copy的Obj</p>
<h3 id="Simulate-this-without-C-17"><a href="#Simulate-this-without-C-17" class="headerlink" title="Simulate *this without C++17"></a>Simulate *this without C++17</h3><p>要這麼做也不是不行</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">test</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> [self = *<span class="keyword">this</span>] &#123; <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, *self.v); &#125;; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>C++17的程式碼比較乾淨，不過這個版本就很清楚知道這個this是複製品了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/03/2019-06-03-useful-tips-for-python-programming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/06/03/2019-06-03-useful-tips-for-python-programming/" class="post-title-link" itemprop="url">Useful Tips for Python Programming</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-06-03 14:32:00" itemprop="dateCreated datePublished" datetime="2019-06-03T14:32:00+00:00">2019-06-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近實在是太頹廢了，強迫自己寫些新東西<br>蟒蛇有些新玩具，可以加入自己的工具組合之中</p>
<h3 id="PySnooper"><a href="#PySnooper" class="headerlink" title="PySnooper"></a>PySnooper</h3><p><a href="https://github.com/cool-RR/pysnooper" target="_blank" rel="noopener">Github Project主業</a><br>首先先安裝<code>pysnooper</code>這個package</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install pysnooper</span><br></pre></td></tr></table></figure>
<p>然後來個最簡單的示範，寫個比官方範例更複雜一點</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@pysnooper.snoop()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findPrimes</span><span class="params">(number)</span>:</span></span><br><span class="line">    num = <span class="number">2</span></span><br><span class="line">    primes = []</span><br><span class="line">    <span class="keyword">while</span> num &lt;= number:</span><br><span class="line">        div = <span class="number">2</span></span><br><span class="line">        flag = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">while</span> div * div &lt;= num <span class="keyword">and</span> flag:</span><br><span class="line">            <span class="keyword">if</span> num % div == <span class="number">0</span>:</span><br><span class="line">                flag = <span class="literal">False</span></span><br><span class="line">            div = div + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">            primes.insert(len(primes), num)</span><br><span class="line">        num = num + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> primes</span><br><span class="line">print(findPrimes(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<p>然後可以列出所有中間產物的過程</p>
<h4 id="輸出到Log-file"><a href="#輸出到Log-file" class="headerlink" title="輸出到Log file"></a>輸出到Log file</h4><p>可以指定到不同的Log file</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pysnooper</span><br><span class="line"></span><br><span class="line"><span class="meta">@pysnooper.snoop("./debug1.log")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isPrime</span><span class="params">(num)</span>:</span></span><br><span class="line">    div = <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> div * div &lt;= num:</span><br><span class="line">        <span class="keyword">if</span> num % div == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        div = div + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@pysnooper.snoop("./debug.log")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findPrimes</span><span class="params">(number)</span>:</span></span><br><span class="line">    num = <span class="number">2</span></span><br><span class="line">    primes = []</span><br><span class="line">    <span class="keyword">while</span> num &lt;= number:</span><br><span class="line">        <span class="keyword">if</span> isPrime(num):</span><br><span class="line">            primes.insert(len(primes), num)</span><br><span class="line">        num = num + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> primes</span><br><span class="line">print(findPrimes(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<h4 id="用不同的Prefix區分"><a href="#用不同的Prefix區分" class="headerlink" title="用不同的Prefix區分"></a>用不同的Prefix區分</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pysnooper</span><br><span class="line"></span><br><span class="line"><span class="meta">@pysnooper.snoop("./debug.log", prefix="--isPrime--")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isPrime</span><span class="params">(num)</span>:</span></span><br><span class="line">    div = <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> div * div &lt;= num:</span><br><span class="line">        <span class="keyword">if</span> num % div == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        div = div + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@pysnooper.snoop("./debug.log", prefix="--findPrimes--")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findPrimes</span><span class="params">(number)</span>:</span></span><br><span class="line">    num = <span class="number">2</span></span><br><span class="line">    primes = []</span><br><span class="line">    <span class="keyword">while</span> num &lt;= number:</span><br><span class="line">        <span class="keyword">if</span> isPrime(num):</span><br><span class="line">            primes.insert(len(primes), num)</span><br><span class="line">        num = num + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> primes</span><br><span class="line">print(findPrimes(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<h3 id="stackprinter"><a href="#stackprinter" class="headerlink" title="stackprinter"></a>stackprinter</h3><p><a href="https://github.com/cknd/stackprinter" target="_blank" rel="noopener">Github Project主業</a><br>要做的還是先裝上去</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install stackprinter</span><br></pre></td></tr></table></figure>
<p>接著我們修改上面的範例，讓它Crash</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isPrime</span><span class="params">(num)</span>:</span></span><br><span class="line">    div = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> div * div &lt;= num:</span><br><span class="line">        <span class="keyword">if</span> num % div == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        div = div + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findPrimes</span><span class="params">(number)</span>:</span></span><br><span class="line">    num = <span class="number">2</span></span><br><span class="line">    primes = []</span><br><span class="line">    <span class="keyword">while</span> num &lt;= number:</span><br><span class="line">        <span class="keyword">if</span> isPrime(num):</span><br><span class="line">            primes.insert(len(primes), num)</span><br><span class="line">        num = num + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> primes</span><br><span class="line">print(findPrimes(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>
<p>執行之後產生以下的 Crash info</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"a.py"</span>, line 20, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    <span class="built_in">print</span>(findPrimes(10))</span><br><span class="line">  File <span class="string">"a.py"</span>, line 16, <span class="keyword">in</span> findPrimes</span><br><span class="line">    <span class="keyword">if</span> isPrime(num):</span><br><span class="line">  File <span class="string">"a.py"</span>, line 7, <span class="keyword">in</span> isPrime</span><br><span class="line">    <span class="keyword">if</span> num % div == 0:</span><br><span class="line">ZeroDivisionError: <span class="built_in">integer</span> division or modulo by zero</span><br></pre></td></tr></table></figure>

<p>如果我們加上了stachpointer</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> stackprinter</span><br><span class="line">stackprinter.set_excepthook(style=<span class="string">'darkbg2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isPrime</span><span class="params">(num)</span>:</span></span><br><span class="line">    div = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> div * div &lt;= num:</span><br><span class="line">        <span class="keyword">if</span> num % div == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        div = div + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">findPrimes</span><span class="params">(number)</span>:</span></span><br><span class="line">    num = <span class="number">2</span></span><br><span class="line">    primes = []</span><br><span class="line">    <span class="keyword">while</span> num &lt;= number:</span><br><span class="line">        <span class="keyword">if</span> isPrime(num):</span><br><span class="line">            primes.insert(len(primes), num)</span><br><span class="line">        num = num + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> primes</span><br><span class="line">print(findPrimes(<span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<p>會變成這樣子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">File a.py, line 20, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    16           <span class="keyword">if</span> isPrime(num):</span><br><span class="line">    17               primes.insert(len(primes), num)</span><br><span class="line">    18           num = num + 1</span><br><span class="line">    19       <span class="built_in">return</span> primes</span><br><span class="line">--&gt; 20   <span class="built_in">print</span>(findPrimes(10))</span><br><span class="line"></span><br><span class="line">File a.py, line 16, <span class="keyword">in</span> findPrimes</span><br><span class="line">    12   def findPrimes(number):</span><br><span class="line">    13       num = 2</span><br><span class="line">    14       primes = []</span><br><span class="line">    15       <span class="keyword">while</span> num &lt;= number:</span><br><span class="line">--&gt; 16           <span class="keyword">if</span> isPrime(num):</span><br><span class="line">    17               primes.insert(len(primes), num)</span><br><span class="line">    ..................................................</span><br><span class="line">     number = 10</span><br><span class="line">     num = 2</span><br><span class="line">     primes = []</span><br><span class="line">    ..................................................</span><br><span class="line"></span><br><span class="line">File a.py, line 7, <span class="keyword">in</span> isPrime</span><br><span class="line">    4    def isPrime(num):</span><br><span class="line">    5        div = 0</span><br><span class="line">    6        <span class="keyword">while</span> div * div &lt;= num:</span><br><span class="line">--&gt; 7            <span class="keyword">if</span> num % div == 0:</span><br><span class="line">    8                <span class="built_in">return</span> False</span><br><span class="line">    ..................................................</span><br><span class="line">     num = 2</span><br><span class="line">     div = 0</span><br><span class="line">    ..................................................</span><br><span class="line"></span><br><span class="line">ZeroDivisionError: <span class="built_in">integer</span> division or modulo by zero</span><br></pre></td></tr></table></figure>
<p>有顏色和箭頭比較容易分析哪裡出錯</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/24/2019-03-24-coroutine-in-c-20/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/24/2019-03-24-coroutine-in-c-20/" class="post-title-link" itemprop="url">Coroutine in C++20</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-24 11:36:00" itemprop="dateCreated datePublished" datetime="2019-03-24T11:36:00+00:00">2019-03-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>既然C++20把Coroutine列為標準配備之後，必須試著了解玩法<br>從最簡單的範例開始</p>
<h3 id="The-simplest-coroutine-example"><a href="#The-simplest-coroutine-example" class="headerlink" title="The simplest coroutine example"></a>The simplest coroutine example</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;experimental/coroutine&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CORETURN_ENABLE</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">generator</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">promise_type</span> &#123;</span></span><br><span class="line">		<span class="keyword">int</span> current_value;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">initial_suspend</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_always&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">final_suspend</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_always&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">get_return_object</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> generator&#123;handle_type::from_promise(*<span class="keyword">this</span>)&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">unhandled_exception</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">exit</span>(<span class="number">1</span>); &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">yield_value</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123; </span><br><span class="line">			current_value = v; </span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_always&#123;&#125;; </span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CORETURN_ENABLE</span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">return_value</span><span class="params">(<span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">			current_value = v;</span><br><span class="line">		&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">return_void</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">move_next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		coro.resume();</span><br><span class="line">		<span class="keyword">return</span> !coro.done();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">current_value</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> coro.promise().current_value; &#125;</span><br><span class="line">	<span class="keyword">using</span> handle_type =	<span class="built_in">std</span>::experimental::coroutine_handle&lt;promise_type&gt;;</span><br><span class="line">	handle_type coro;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">generator <span class="title">count</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">co_yield</span> <span class="number">42</span>;</span><br><span class="line">	<span class="keyword">co_yield</span> <span class="number">56</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CORETURN_ENABLE</span></span><br><span class="line">	<span class="keyword">co_return</span> <span class="number">999</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> g = count();</span><br><span class="line">	<span class="keyword">while</span> (g.move_next())</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; g.current_value() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CORETURN_ENABLE</span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; g.current_value() &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>假設我們有一個Coroutine的程式碼片段，例如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TRet, <span class="keyword">typename</span> … TArgs&gt;</span><br><span class="line"><span class="function">TRet <span class="title">func</span><span class="params">(TArgs args…)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>邊義氣會幫我們做類似這樣的處理</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TRet, <span class="keyword">typename</span> ... TArgs&gt;</span><br><span class="line"><span class="function">TRet <span class="title">func</span><span class="params">(TArgs args...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">promise_t</span> = <span class="keyword">typename</span> coroutine_traits&lt;TRet, TArgs...&gt;::promise_type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">promise_t</span> promise;</span><br><span class="line">    <span class="keyword">auto</span> __return__ = promise.get_return_object();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">co_await</span> promise.initial_suspend();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;            <span class="comment">// co_return expr; =&gt; promise.return_value(expr); goto final_suspend;</span></span><br><span class="line">        body;    <span class="comment">// co_return;      =&gt; promise.return_void(); goto final_suspend;</span></span><br><span class="line">    &#125;            <span class="comment">// co_yield expr;  =&gt; co_await promise.yield_value(expr);</span></span><br><span class="line">    <span class="keyword">catch</span> (...)</span><br><span class="line">    &#123;</span><br><span class="line">        promise.set_exception(<span class="built_in">std</span>::current_exception());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">final_suspend:</span><br><span class="line">    <span class="keyword">co_await</span> promise.final_suspend();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>對照Pseudo code <code>func</code>和上面範例的<code>count</code>ˇ以及<code>promise_t</code>和<code>generator::promise_type</code>明白了一些東西</p>
<p>– 任何包含<code>co_yield</code>，<code>co_return</code>或者<code>co_await</code>的程式碼都是<code>corutine block</code>，必須定義一個structure，而這個structure必須有個promise_type<br>– promeise_type需要六個函數， <code>return_value</code>和<code>return_void</code>不可同時存在<br>– 中間狀態必須保存在promise_type中<br>– 當<code>co_yield</code>交出控制權之後，必須使用<code>coro.resume()</code>恢復執行</p>
<p>以下討論另外一個關鍵字 <code>co_await</code></p>
<h3 id="co-await"><a href="#co-await" class="headerlink" title="co_await"></a>co_await</h3><p>先從古早時期的Callback說起，給出一個範例</p>
<h4 id="From-a-callback-start"><a href="#From-a-callback-start" class="headerlink" title="From a callback start"></a>From a callback start</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> call_back = <span class="built_in">std</span>::function&lt;<span class="keyword">void</span>(<span class="keyword">int</span>)&gt;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Add100ByCallback</span><span class="params">(<span class="keyword">int</span> init, call_back f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function"><span class="built_in">std</span>::thread <span class="title">t</span><span class="params">([init, f]() &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">1</span>));</span></span></span><br><span class="line"><span class="function"><span class="params">		f(init + <span class="number">100</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">	&#125;)</span></span>;</span><br><span class="line">	t.detach();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Add100ByCallback(<span class="number">10</span>, [](<span class="keyword">int</span> v) &#123;</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; v &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">std</span>::this_thread::sleep_for(<span class="built_in">std</span>::chrono::seconds(<span class="number">5</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程式本身沒有什麼意義，只是模擬長時間處理的情形</p>
<h4 id="Awaitable-object"><a href="#Awaitable-object" class="headerlink" title="Awaitable object"></a>Awaitable object</h4><p>Coroutine版根據上面的版本修改，新增了一些東西</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Task</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">promise_type</span> &#123;</span></span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">get_return_object</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> Task&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">initial_suspend</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_never&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">final_suspend</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_never&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">unhandled_exception</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">terminate</span>(); &#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">return_void</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Add100AWaitable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	Add100AWaitable(<span class="keyword">int</span> init) :init_(init) &#123;&#125;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">await_ready</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> <span class="literal">false</span>; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">await_resume</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> result_; &#125;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">await_suspend</span><span class="params">(<span class="built_in">std</span>::experimental::coroutine_handle&lt;&gt; handle)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">auto</span> f = [handle, <span class="keyword">this</span>](<span class="keyword">int</span> value) <span class="keyword">mutable</span> &#123;</span><br><span class="line">			result_ = value;</span><br><span class="line">			handle.resume(); </span><br><span class="line">		&#125;;</span><br><span class="line">		Add100ByCallback(init_, f);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> init_;</span><br><span class="line">	<span class="keyword">int</span> result_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">Task <span class="title">Add100ByCoroutine</span><span class="params">(<span class="keyword">int</span> init, call_back f)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Before co_await: "</span> &lt;&lt;<span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="keyword">co_await</span> Add100AWaitable(init);</span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"After co_await: "</span> &lt;&lt; <span class="built_in">std</span>::this_thread::get_id() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">	f(ret);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的Task不需要多做介紹，<code>Add100ByCoroutine</code>也不需要多說些什麼<br>直接看<code>Add100AWaitable</code>的部分<br>同樣的<code>Add100AWaitable</code>也有必須要注意的點<br>– 中間值一樣存在 <code>Awaitable object</code>中<br>– 必須有<code>await_ready</code>，<code>await_resume</code>和<code>await_suspend</code>的存在<br>– 以上面的例子來看，當Callback完成之後，我們手動讓Coroutine繼續執行上去<br>– 呼叫Add100ByCoroutine和corutime resume的Thread不一定是同一個，需要把狀態保留到awaitable object中</p>
<h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><p><a href="https://kirit.com/How%20C%2B%2B%20coroutines%20work" target="_blank" rel="noopener">How C++ coroutines work</a><br><a href="https://lewissbaker.github.io/2017/09/25/coroutine-theory" target="_blank" rel="noopener">Coroutine Theory</a><br><a href="https://msdn.microsoft.com/en-us/magazine/mt826346" target="_blank" rel="noopener">From Algorithms to Coroutines in C++</a><br><a href="https://toby-allsopp.github.io/2017/04/22/coroutines-reference-params.html" target="_blank" rel="noopener">Coroutines and Reference Parameters</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/20/2019-03-20-pythagorean-triples-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/20/2019-03-20-pythagorean-triples-code/" class="post-title-link" itemprop="url">Pythagorean Triples Code</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-20 12:18:00" itemprop="dateCreated datePublished" datetime="2019-03-20T12:18:00+00:00">2019-03-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Range-V3要進C++20 Standard，看了一下他給的範例</p>
<p><a href="https://en.wikipedia.org/wiki/Pythagorean_triple" target="_blank" rel="noopener">Pythagorean triple</a>如何印出前十組Pythagorean triple</p>
<p>從最簡單的方案開始看</p>
<h3 id="Direct-Method"><a href="#Direct-Method" class="headerlink" title="Direct Method"></a>Direct Method</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">1</span>; <span class="literal">true</span>; ++z) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">1</span>; x &lt; z; ++x) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> y = x; y &lt; z; ++y) &#123;</span><br><span class="line">				<span class="keyword">if</span> (x * x + y * y == z * z) &#123;</span><br><span class="line">					<span class="built_in">printf</span>(<span class="string">"(%d,%d,%d)\n"</span>, x, y, z);</span><br><span class="line">					<span class="keyword">if</span> (++i == <span class="number">10</span>) <span class="keyword">goto</span> done;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">done:;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不會很難理解，必須迴圈外部維護一個狀態，當狀態滿足之後強行離開迴圈</p>
<h3 id="Callback-Solution"><a href="#Callback-Solution" class="headerlink" title="Callback Solution"></a>Callback Solution</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tuple&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;type_traits&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">F</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">auto</span> <span class="title">boolify</span>(<span class="title">F</span>&amp; <span class="title">f</span>) &#123;</span></span><br><span class="line">	<span class="keyword">return</span> [&amp;](<span class="keyword">auto</span>&amp;&amp;... args) &#123;</span><br><span class="line">		<span class="keyword">using</span> R = <span class="keyword">decltype</span>(f(<span class="built_in">std</span>::forward&lt;<span class="keyword">decltype</span>(args)&gt;(args)...));</span><br><span class="line">		<span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(<span class="built_in">std</span>::is_void_v&lt;R&gt;)</span> </span>&#123;</span><br><span class="line">			f(<span class="built_in">std</span>::forward&lt;<span class="keyword">decltype</span>(args)&gt;(args)...);</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> f(<span class="built_in">std</span>::forward&lt;<span class="keyword">decltype</span>(args)&gt;(args)...);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">F</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">generate_triples</span>(<span class="title">F</span> <span class="title">f</span>) &#123;</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">1</span>; <span class="literal">true</span>; ++z) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">1</span>; x &lt; z; ++x) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> y = x; y &lt; z; ++y) &#123;</span><br><span class="line">				<span class="keyword">if</span> (x*x + y * y == z * z) &#123;</span><br><span class="line">					<span class="keyword">bool</span> stop = boolify(f)(<span class="built_in">std</span>::make_tuple(x, y, z));</span><br><span class="line">					<span class="keyword">if</span> (stop) <span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">F</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">auto</span> <span class="title">take</span>(<span class="title">int</span> <span class="title">k</span>, <span class="title">F</span> <span class="title">f</span>) &#123;</span></span><br><span class="line">	<span class="keyword">return</span> [f, i = k](<span class="keyword">auto</span> x) <span class="keyword">mutable</span> -&gt; <span class="keyword">bool</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (i-- == <span class="number">0</span>) || boolify(f)(x);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	generate_triples(</span><br><span class="line">		take(<span class="number">10</span>,</span><br><span class="line">			[&amp;](<span class="keyword">auto</span> triple) &#123;</span><br><span class="line">				<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'('</span></span><br><span class="line">					&lt;&lt; <span class="built_in">std</span>::get&lt;<span class="number">0</span>&gt;(triple) &lt;&lt; <span class="string">','</span></span><br><span class="line">					&lt;&lt; <span class="built_in">std</span>::get&lt;<span class="number">1</span>&gt;(triple) &lt;&lt; <span class="string">','</span></span><br><span class="line">					&lt;&lt; <span class="built_in">std</span>::get&lt;<span class="number">2</span>&gt;(triple) &lt;&lt; <span class="string">')'</span> &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		)</span><br><span class="line">	);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這個難看懂很多<br>首先程式主體</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">F</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">void</span> <span class="title">generate_triples</span>(<span class="title">F</span> <span class="title">f</span>) &#123;</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">1</span>; <span class="literal">true</span>; ++z) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">1</span>; x &lt; z; ++x) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> y = x; y &lt; z; ++y) &#123;</span><br><span class="line">				<span class="keyword">if</span> (x*x + y * y == z * z) &#123;</span><br><span class="line">					<span class="keyword">bool</span> stop = boolify(f)(<span class="built_in">std</span>::make_tuple(x, y, z));</span><br><span class="line">					<span class="keyword">if</span> (stop) <span class="keyword">return</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是沒壁的，我們的中止條件就在 <code>take(10, ...)</code>這個函數之間<br>一旦滿足條件，整個<code>genertat4e_tyiples</code>就結束了<br>我們看看 <code>take</code>的實作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">F</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">auto</span> <span class="title">take</span>(<span class="title">int</span> <span class="title">k</span>, <span class="title">F</span> <span class="title">f</span>) &#123;</span></span><br><span class="line">	<span class="keyword">return</span> [f, i = k](<span class="keyword">auto</span> x) <span class="keyword">mutable</span> -&gt; <span class="keyword">bool</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (i-- == <span class="number">0</span>) || boolify(f)(x);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我們把state包含在lambda之中，避免被外界汙染<br>至於<code>boolify</code>這個函數不重要，不影響分析</p>
<p>這個版本比起上面那個，邏輯切個更清晰<br>不過複雜度也跟著增加了</p>
<h3 id="Coroutine-Solution"><a href="#Coroutine-Solution" class="headerlink" title="Coroutine Solution"></a>Coroutine Solution</h3><p>隨著C++20加入stackless coroutine，這個問題也可以用coroutine來解</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;tuple&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;experimental/coroutine&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">generator</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">promise_type</span>;</span></span><br><span class="line">	<span class="keyword">using</span> handle = <span class="built_in">std</span>::experimental::coroutine_handle&lt;promise_type&gt;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">promise_type</span> &#123;</span></span><br><span class="line">		T current_value;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">get_return_object</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> generator&#123; handle::from_promise(*<span class="keyword">this</span>) &#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">initial_suspend</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_always&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">final_suspend</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_always&#123;&#125;; &#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">unhandled_exception</span><span class="params">()</span> </span>&#123; <span class="built_in">std</span>::<span class="built_in">terminate</span>(); &#125;</span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">return_void</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">		<span class="function"><span class="keyword">auto</span> <span class="title">yield_value</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">			current_value = value;</span><br><span class="line">			<span class="keyword">return</span> <span class="built_in">std</span>::experimental::suspend_always&#123;&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="function"><span class="keyword">bool</span> <span class="title">move_next</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> coro ? (coro.resume(), !coro.done()) : <span class="literal">false</span>; &#125;</span><br><span class="line">	<span class="function">T <span class="title">current_value</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> coro.promise().current_value; &#125;</span><br><span class="line">	generator(generator <span class="keyword">const</span>&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	generator(generator &amp;&amp; rhs) : coro(rhs.coro) &#123; rhs.coro = <span class="literal">nullptr</span>; &#125;</span><br><span class="line">	~generator() &#123; <span class="keyword">if</span> (coro) coro.destroy(); &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	generator(handle h) : coro(h) &#123;&#125;</span><br><span class="line">	handle coro;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">auto triples() -&gt; generator&lt;std::tuple&lt;int, int, int&gt;&gt; &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">1</span>; <span class="literal">true</span>; ++z) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">1</span>; x &lt; z; ++x) &#123;</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> y = x; y &lt; z; ++y) &#123;</span><br><span class="line">				<span class="keyword">if</span> (x*x + y * y == z * z) &#123;</span><br><span class="line">					<span class="function"><span class="keyword">co_yield</span> <span class="title">std::make_tuple</span><span class="params">(x, y, z)</span></span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">auto</span> g = triples();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">		g.move_next();</span><br><span class="line">		<span class="keyword">auto</span> triple = g.current_value();</span><br><span class="line">		<span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">'('</span></span><br><span class="line">			&lt;&lt; <span class="built_in">std</span>::get&lt;<span class="number">0</span>&gt;(triple) &lt;&lt; <span class="string">','</span></span><br><span class="line">			&lt;&lt; <span class="built_in">std</span>::get&lt;<span class="number">1</span>&gt;(triple) &lt;&lt; <span class="string">','</span></span><br><span class="line">			&lt;&lt; <span class="built_in">std</span>::get&lt;<span class="number">2</span>&gt;(triple) &lt;&lt; <span class="string">')'</span> &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由於coroutine還是新玩意，目前對他的掌握度不適很高，這個方案僅供參考</p>
<h3 id="Range-V3-Solution"><a href="#Range-V3-Solution" class="headerlink" title="Range-V3 Solution"></a>Range-V3 Solution</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A sample standard C++20 program that prints</span></span><br><span class="line"><span class="comment">// the first N Pythagorean triples.</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;optional&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;range/v3/all.hpp&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::get;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::optional;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::make_tuple;</span><br><span class="line"><span class="keyword">using</span> <span class="built_in">std</span>::<span class="built_in">cout</span>;</span><br><span class="line"><span class="keyword">using</span> ranges::view_interface;</span><br><span class="line"><span class="keyword">using</span> ranges::<span class="keyword">iterator_t</span>;</span><br><span class="line"><span class="keyword">namespace</span> view = ranges::v3::view;</span><br><span class="line"></span><br><span class="line"><span class="comment">// maybe_view defines a view over zero or one</span></span><br><span class="line"><span class="comment">// objects.</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="title">struct</span> <span class="title">maybe_view</span> :</span> view_interface&lt;maybe_view&lt;T&gt;&gt; &#123;</span><br><span class="line">  maybe_view() = <span class="keyword">default</span>;</span><br><span class="line">  maybe_view(T t) : data_(<span class="built_in">std</span>::move(t)) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">T <span class="keyword">const</span> *<span class="title">begin</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> data_ ? &amp;*data_ : <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function">T <span class="keyword">const</span> *<span class="title">end</span><span class="params">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> data_ ? &amp;*data_ + <span class="number">1</span> : <span class="literal">nullptr</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  optional&lt;T&gt; data_&#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// "for_each" creates a new view by applying a</span></span><br><span class="line"><span class="comment">// transformation to each element in an input</span></span><br><span class="line"><span class="comment">// range, and flattening the resulting range of</span></span><br><span class="line"><span class="comment">// ranges.</span></span><br><span class="line"><span class="comment">// (This uses one syntax for constrained lambdas</span></span><br><span class="line"><span class="comment">// in C++20.)</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> for_each =</span><br><span class="line">  [](<span class="keyword">auto</span>&amp;&amp; r, <span class="keyword">auto</span> fun) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">decltype</span>(r)(r)</span><br><span class="line">        | view::transform(<span class="built_in">std</span>::move(fun))</span><br><span class="line">        | view::join;</span><br><span class="line">  &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// "yield_if" takes a bool and a value and</span></span><br><span class="line"><span class="comment">// returns a view of zero or one elements.</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">constexpr</span> <span class="keyword">auto</span> yield_if =</span><br><span class="line">  [](<span class="keyword">bool</span> b, <span class="keyword">auto</span> x) &#123;</span><br><span class="line">    <span class="keyword">return</span> b ? maybe_view&#123;<span class="built_in">std</span>::move(x)&#125;</span><br><span class="line">             : maybe_view&lt;<span class="keyword">decltype</span>(x)&gt;&#123;&#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Define an infinite range of all the</span></span><br><span class="line">  <span class="comment">// Pythagorean triples:</span></span><br><span class="line">  <span class="keyword">using</span> view::iota;</span><br><span class="line">  <span class="keyword">auto</span> triples =</span><br><span class="line">    for_each(iota(<span class="number">1</span>), [](<span class="keyword">int</span> z) &#123;</span><br><span class="line">      <span class="keyword">return</span> for_each(iota(<span class="number">1</span>, z+<span class="number">1</span>), [=](<span class="keyword">int</span> x) &#123;</span><br><span class="line">        <span class="keyword">return</span> for_each(iota(x, z+<span class="number">1</span>), [=](<span class="keyword">int</span> y) &#123;</span><br><span class="line">          <span class="keyword">return</span> yield_if(x*x + y*y == z*z,</span><br><span class="line">            make_tuple(x, y, z));</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Display the first 10 triples</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> triple : triples | view::take(<span class="number">10</span>)) &#123;</span><br><span class="line">      <span class="built_in">cout</span> &lt;&lt; <span class="string">'('</span></span><br><span class="line">           &lt;&lt; get&lt;<span class="number">0</span>&gt;(triple) &lt;&lt; <span class="string">','</span></span><br><span class="line">           &lt;&lt; get&lt;<span class="number">1</span>&gt;(triple) &lt;&lt; <span class="string">','</span></span><br><span class="line">           &lt;&lt; get&lt;<span class="number">2</span>&gt;(triple) &lt;&lt; <span class="string">')'</span> &lt;&lt; <span class="string">'\n'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看起來還不錯，不過編譯時間嚇死人…<br>目前還是先考慮方案一或二吧，三和四等掌握度高一點再說</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/02/2019-02-02-custom-builds-process-in-golang-rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/02/2019-02-02-custom-builds-process-in-golang-rust/" class="post-title-link" itemprop="url">Custom build  process in Golang / Rust</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-02 11:37:00" itemprop="dateCreated datePublished" datetime="2019-02-02T11:37:00+00:00">2019-02-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/" itemprop="url" rel="index"><span itemprop="name">Golang</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Golang/Rust/" itemprop="url" rel="index"><span itemprop="name">Rust</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>這需求有點奇怪，不過這倒是我想要的編譯流程<br>先從Golang來說吧，1.11前的版本只會把dependency module都裝入GOPATH中，就算有<code>godep</code>之類的東西也覺得不好用</p>
<p>由於自己是Developer，需要分析Module間的互動，甚至改改程式碼，分析一下，放在GOPATH不是不好，只是我想要以下的需求</p>
<p>– 修改Dependcny Module的程式碼，由於牽一髮動全身，改動之後可能造成其他相依於此Module的全部掛點<br>– 希望放在Repo附近，而不是在GOPATH底下尋找</p>
<p>Cargo跟GoLang的行為模式差不多，Module放在<code>.cargo</code>底下<br>不利於開發研究</p>
<p>於是找出一套屬於自己的方式了</p>
<h3 id="Golang"><a href="#Golang" class="headerlink" title="Golang"></a>Golang</h3><p>首先，先安裝到Golang 1.11以上<br>以<a href="https://github.com/sjqzhang/go-fastdfs" target="_blank" rel="noopener">go-fastdfs</a>舉例，他缺少<code>go.mod</code>，於是我們自行補上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/sjqzhang/go-fastdfs</span><br><span class="line">$ <span class="built_in">cd</span> go-fastdfs</span><br><span class="line">$ rm vendor -r  <span class="comment"># 刪除掉原先的vendor目錄</span></span><br><span class="line">$ go mod init</span><br><span class="line">go: creating new go.mod: module github.com/sjqzhang/go-fastdfs</span><br><span class="line">$ go mod vendor <span class="comment"># 這下Dependcy Module都在vendor底下了</span></span><br><span class="line">$ go build -mod=vendor <span class="comment"># 產生go-fastdfs了</span></span><br><span class="line"><span class="comment"># 接著在修改vendor/github.com/astaxie/beego/httplib/httplib.go</span></span><br><span class="line"><span class="comment"># 使其編譯不過</span></span><br><span class="line">$ go build -mod=vendor</span><br><span class="line">./fileserver.go:264:13: undefined: httplib.BeegoHTTPSettings</span><br></pre></td></tr></table></figure>
<p>看來真的是用vendor目錄下的Module下去編譯</p>
<h3 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h3><p>Cargo的部分麻煩一點<br>首先先安裝<a href="https://github.com/alexcrichton/cargo-vendor" target="_blank" rel="noopener">cargo-vendor
</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo install cargo-vendor</span><br></pre></td></tr></table></figure>
<p>用<a href="https://github.com/paritytech/yamux" target="_blank" rel="noopener">yamux</a>來舉例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/paritytech/yamux</span><br><span class="line">$ <span class="built_in">cd</span> yamux</span><br><span class="line">$ cargo vendor &gt; ~/.cargo/config</span><br><span class="line">$ cargo build</span><br></pre></td></tr></table></figure>
<p>如果要修改vendor裡面的東西比較麻煩<br>假設我們修改<code>vendor/tokio-io/src/framed_read.rs</code><br>下build之後可能出現</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cargo build</span><br><span class="line">error: the listed checksum of `/yamux/vendor/tokio-io/src/framed_read.rs` has changed:</span><br><span class="line">expected: 07e36ff58fe30bf7b0aa28a998b0bc4e2f78acd04cc1570a877b4eeac1cadcf7</span><br><span class="line">actual:   d10d30e1bc1f1d1abc7c28db97fd37ee374d029329aaa78df328bb076163363d</span><br><span class="line"></span><br><span class="line">directory sources are not intended to be edited, <span class="keyword">if</span> modifications are required <span class="keyword">then</span> it is recommended that [replace] is used with a forked copy of the <span class="built_in">source</span></span><br></pre></td></tr></table></figure>
<p>由於我們改了檔案，checksum算出來就不同了<br>簡易的方案就是在root dir的<code>Cargo.tmol</code>上加上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[replace]</span><br><span class="line">&quot;tokio-io:0.1.11&quot; &#x3D; &#123; path &#x3D; &#39;.&#x2F;vendor&#x2F;tokio-io&#39; &#125;</span><br></pre></td></tr></table></figure>
<p>注意版本號要跟vendor的目錄相同，不然無法編譯</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/27/2018-12-27-experience-on-writing-a-on-the-fly-mp4-muxer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/27/2018-12-27-experience-on-writing-a-on-the-fly-mp4-muxer/" class="post-title-link" itemprop="url">Experience on writing a on-the-fly mp4 muxer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-27 02:31:00" itemprop="dateCreated datePublished" datetime="2018-12-27T02:31:00+00:00">2018-12-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Multimedia-FFMpeg/" itemprop="url" rel="index"><span itemprop="name">Multimedia FFMpeg</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>MP4 Muxer的作法，網路上可以找到上百篇，不過On the fly的不多，只好自己動手做了<br>在這邊走了不少冤枉路，寫起來免得忘記<br>目標寫一個Library，從Raw H264 Stream和Raw G711 Stream中，打包變成MP4的故事</p>
<h3 id="Libavformat-Libavcodec"><a href="#Libavformat-Libavcodec" class="headerlink" title="Libavformat / Libavcodec"></a>Libavformat / Libavcodec</h3><p>大部分多媒體的問題，絕對少不了跟ffmpeg打交道的經驗，所以也在社面花了一點時間</p>
<h4 id="Raw-H264-to-MP4"><a href="#Raw-H264-to-MP4" class="headerlink" title="Raw H264 to MP4"></a>Raw H264 to MP4</h4><p>由於我們不是走正規路線使用，Google了一下找到<a href="https://stackoverflow.com/questions/5964142/raw-h264-frames-in-mpegts-container-using-libavcodec" target="_blank" rel="noopener">Stackoverflow</a>的這篇，沒有什麼問題，不過AV Sync又是另外一個問題，之後再談</p>
<h4 id="G711-to-AAC"><a href="#G711-to-AAC" class="headerlink" title="G711 to AAC"></a>G711 to AAC</h4><p>這點實在搞得我很頭大啊<br>G711 to PCM這段其實還好，相關的程式碼 <a href="https://blog.csdn.net/g0415shenw/article/details/81432854" target="_blank" rel="noopener">這裡</a>有<br>問題在於PCM轉AAC，其中有兩個困難處</p>
<p>– G711的Sample Format是AV_SAMPLE_FMT_S16，不考慮外接AAC Enocder的話，FFmpeg AAC Encoder的Sample Format是AV_SAMPLE_FMT_FLTP，所以需要透過Resampling轉換</p>
<p>– 轉換過的Sample樹不一定跟原先取樣數相同，所以還需要放到Audio Fifo Buffer，等到數目夠的才處理</p>
<p>大致流程可以參考<a href="https://github.com/FFmpeg/FFmpeg/blob/master/doc/examples/transcode_aac.c" target="_blank" rel="noopener">FFMmpeg的範例</a>，一整個麻煩</p>
<h4 id="AV-Sync"><a href="#AV-Sync" class="headerlink" title="AV Sync"></a>AV Sync</h4><p>好不容易通過前兩關，卻死在第三關，也是照<a href="https://github.com/FFmpeg/FFmpeg/blob/master/doc/examples/muxing.c" target="_blank" rel="noopener">FFMpeg的範例</a>來處理PTS的問題，結果怎麼調都失敗，果斷放棄這絲路了，另謀其他做法</p>
<h3 id="libmp4v2-EasyAACEncoder"><a href="#libmp4v2-EasyAACEncoder" class="headerlink" title="libmp4v2 / EasyAACEncoder"></a>libmp4v2 / EasyAACEncoder</h3><p>不得不大力稱讚<a href="https://github.com/EasyDarwin/EasyAACEncoder" target="_blank" rel="noopener">EasyAACEncoder</a>這個Project，把G711 to AAC這段難點彌平了不少，不過還是採到坑了<br>libmp4v2網路上教學不少，就不特別獎了，來說一下遇到那些問題</p>
<h4 id="MP4裡面要放Raw-Stream"><a href="#MP4裡面要放Raw-Stream" class="headerlink" title="MP4裡面要放Raw Stream"></a>MP4裡面要放Raw Stream</h4><p>所以在 <code>PcmToAac.cpp</code>裡面要做如下修改</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*0 - raw; 1 - ADTS*/</span></span><br><span class="line">pConfiguration-&gt;outputFormat = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>看起來都沒問題的部分最後變成夢靨啊..</p>
<h4 id="AV-Sync-1"><a href="#AV-Sync-1" class="headerlink" title="AV Sync"></a>AV Sync</h4><p>在上面遇到的問題在這邊也遇到，不過這次找到可行解了，可喜可賀<br><a href="https://blog.csdn.net/baiseled/article/details/52643223" target="_blank" rel="noopener">解法在此</a></p>
<h4 id="Quicktime-issue"><a href="#Quicktime-issue" class="headerlink" title="Quicktime issue"></a>Quicktime issue</h4><p>路出來的檔案在大部分撥放軟體都沒問題，結果在Quicktime和iOS出問題，<strong>Quicktime波一波聲音就消失了</strong>，也沒有Open Source可以參考，於是就進入鬼打牆，瞎子摸象的階段<br>經過多方查證之下，MP4 Info沒什麼問題，不是libmp4v2的問題<br>試著用ffmpeg轉檔，啜了以下實驗</p>
<p>– 用FFmpeg轉檔，Video / Audio 照舊，QuickTime還是不能播</p>
<p>– 用FFmpeg轉檔，Video照舊，Auido 用FFmpeg AAC Encoder，結果他能撥了</p>
<p>不過我不想走回第一條的路，那太可怕了<br>不過在ffmpeg轉檔時看到一行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Multiple frames in a packet.</span><br></pre></td></tr></table></figure>
<p>這行一直被我忽略掉，因為ffplay沒抱怨，不過走投無路了只好猜是AAC的問題</p>
<h4 id="Revisist-EasyAACEncoder"><a href="#Revisist-EasyAACEncoder" class="headerlink" title="Revisist EasyAACEncoder"></a>Revisist EasyAACEncoder</h4><p>既然懷疑一個Packet裡面有多個Fframe<br>那可能是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Easy_AACEncoder_Encode(handle, pbG726Buffer, gBytesRead, pbAACBuffer, &amp;out_len)</span><br></pre></td></tr></table></figure>
<p>有多個frame吐出來，不過沒有ADTS Header我們無法分辨出FFrame Boundary，於是我們又把ADTS家回去了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*0 - raw; 1 - ADTS*/</span></span><br><span class="line">pConfiguration-&gt;outputFormat = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>之在外面切割Frame，在一個一個填入MP4，這下Quicktime和iOS就正常了</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>走了這麼多冤枉路，終於完成一個能動的方案<br>用FFMpeg方案沒有不好，不過我方面的經驗不夠，之前也沒做太多涉獵<br>用第二個方案也是遇到了困難，有碰到問題才會知道痛</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/26/2018-10-26-packing-webassembly-modules-into-unique-javascript-file/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/26/2018-10-26-packing-webassembly-modules-into-unique-javascript-file/" class="post-title-link" itemprop="url">Packing webassembly modules into unique javascript file</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-26 14:21:00" itemprop="dateCreated datePublished" datetime="2018-10-26T14:21:00+00:00">2018-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/" itemprop="url" rel="index"><span itemprop="name">Rust</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/Javascript/" itemprop="url" rel="index"><span itemprop="name">Javascript</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Rust/Javascript/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>大家都知道Webpack可以打包許多的Javascript files成一個，方便取用<br>如果我們的Javascript使用到Webassembly的話可否比照辦理，答案是肯定的<br>But，我不會用Webpack打包，我也不是專門前端的人，不想花太多時間研究<br>於是我就改用腦殘版<a href="https://github.com/parcel-bundler/parcel" target="_blank" rel="noopener">Parcel</a><br>零設定就產生了，有興趣的話可以參考<a href="https://github.com/HungMingWu/parcel-wasm-example" target="_blank" rel="noopener">demo</a><br>接下來的重點是如何放在如何生成Webassembly</p>
<h3 id="AssemblyScript"><a href="#AssemblyScript" class="headerlink" title="AssemblyScript"></a>AssemblyScript</h3><p><a href="https://github.com/AssemblyScript/assemblyscript" target="_blank" rel="noopener">AssemblyScript</a><br>Typescript的subset，會寫前端的話這套適用，不過我是System Language的愛好者</p>
<h3 id="Rust"><a href="#Rust" class="headerlink" title="Rust"></a>Rust</h3><p>Rust對Webassembly的支援還真是高啊..只要<code>Cargo.toml</code>中定義成Shared Library<br>然後下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cargo build --target wasm32-unknown-unknown  --release</span><br></pre></td></tr></table></figure>
<p>就好了，不過百廢待舉啊</p>
<h3 id="C-C"><a href="#C-C" class="headerlink" title="C/C++"></a>C/C++</h3><p>基本上有兩個方案<br>– <a href="https://github.com/kripken/emscripten" target="_blank" rel="noopener">Emscripten</a> 走原先ASM.JS的老路，不過無法直接將生成的wasm放到我的demo上跑<br>– <a href="https://github.com/yurydelendik/wasmception" target="_blank" rel="noopener">Minimal C/C++ language toolset for building wasm files</a><br>   有潛力，不過我沒一次成功過，也不能搭配CMake一起使用，還是個半殘品</p>
<h3 id="結論"><a href="#結論" class="headerlink" title="結論"></a>結論</h3><p>在觀望吧，現在還不是成熟的時刻</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/05/2018-09-05-wrapper-stdvector-for-serialization-deserialization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/05/2018-09-05-wrapper-stdvector-for-serialization-deserialization/" class="post-title-link" itemprop="url">Wrapper std::vector for serialization / deserialization</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-05 13:51:00" itemprop="dateCreated datePublished" datetime="2018-09-05T13:51:00+00:00">2018-09-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C++</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>C++ 的Serialization / Deserialization已經很成熟了<br>有了Boost 和 Cereal可以選，不過它們需要<code>ifstream</code>和<code>ofstream</code>做參數傳入<br>如果我們需要用於網路傳輸跟Database該怎麼辦<br>Boost ASIO幫我們解決了這個問題</p>
<h3 id="Output-Wrapper"><a href="#Output-Wrapper" class="headerlink" title="Output Wrapper"></a>Output Wrapper</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> SinkType, <span class="keyword">typename</span> CharType&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">container_sink</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">typedef</span> CharType char_type;</span><br><span class="line">	<span class="keyword">typedef</span> boost::iostreams::sink_tag category;</span><br><span class="line"></span><br><span class="line">	container_sink(Container&amp; container)</span><br><span class="line">		: container_(container)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">static_assert</span>(<span class="keyword">sizeof</span>(SinkType) == <span class="keyword">sizeof</span>(CharType), <span class="string">"invalid size"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="built_in">std</span>::streamsize <span class="title">write</span><span class="params">(<span class="keyword">const</span> char_type* buffer, <span class="built_in">std</span>::streamsize size)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> safe_sink = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">const</span> SinkType*&gt;(buffer);</span><br><span class="line">		container_.insert(container_.end(), safe_sink, safe_sink + size);</span><br><span class="line">		<span class="keyword">return</span> size;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	Container&amp; container_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container&gt;</span><br><span class="line"><span class="keyword">using</span> byte_sink = container_sink&lt;Container, <span class="keyword">uint8_t</span>, <span class="keyword">char</span>&gt;;</span><br><span class="line"><span class="keyword">using</span> data_sink = boost::iostreams::stream&lt;byte_sink&lt;data_chunk&gt;&gt;;</span><br></pre></td></tr></table></figure>
<p>如何使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">data_chunk data;</span><br><span class="line"><span class="function">data_sink <span class="title">ostream</span><span class="params">(data)</span></span>;</span><br><span class="line">boost::<span class="function">archive::binary_oarchive <span class="title">oa</span><span class="params">(ostream)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">const</span> gps_position <span class="title">g</span><span class="params">(<span class="number">35</span>, <span class="number">59</span>, <span class="number">24.567f</span>)</span></span>;</span><br><span class="line">oa &lt;&lt; g;</span><br><span class="line">ostream.flush();</span><br><span class="line"><span class="keyword">return</span> ostream;</span><br></pre></td></tr></table></figure>

<h3 id="Input-Wrapper"><a href="#Input-Wrapper" class="headerlink" title="Input Wrapper"></a>Input Wrapper</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container, <span class="keyword">typename</span> SourceType, <span class="keyword">typename</span> CharType&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">container_source</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">typedef</span> CharType char_type;</span><br><span class="line">	<span class="keyword">typedef</span> boost::iostreams::source_tag category;</span><br><span class="line"></span><br><span class="line">	container_source(<span class="keyword">const</span> Container&amp; container)</span><br><span class="line">		: container_(container), position_(<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">static_assert</span>(<span class="keyword">sizeof</span>(SourceType) == <span class="keyword">sizeof</span>(CharType), <span class="string">"invalid size"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="built_in">std</span>::streamsize <span class="title">read</span><span class="params">(char_type* buffer, <span class="built_in">std</span>::streamsize size)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> amount = container_.size() - position_;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> result = <span class="built_in">std</span>::min(size,</span><br><span class="line">			<span class="keyword">static_cast</span>&lt;<span class="built_in">std</span>::streamsize&gt;(amount));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// <span class="doctag">TODO:</span> use ios eof symbol (template-based).</span></span><br><span class="line">		<span class="keyword">if</span> (result &lt;= <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> value = <span class="keyword">static_cast</span>&lt;<span class="keyword">typename</span> Container::size_type&gt;(result);</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> limit = position_ + value;</span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> start = container_.begin() + position_;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">const</span> <span class="keyword">auto</span> end = container_.begin() + limit;</span><br><span class="line">		<span class="built_in">std</span>::copy(start, end, buffer);</span><br><span class="line">		position_ = limit;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="keyword">const</span> Container&amp; container_;</span><br><span class="line">	<span class="keyword">typename</span> Container::size_type position_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Container&gt;</span><br><span class="line"><span class="keyword">using</span> byte_source = container_source&lt;Container, <span class="keyword">uint8_t</span>, <span class="keyword">char</span>&gt;;</span><br><span class="line"><span class="keyword">using</span> data_source = boost::iostreams::stream&lt;byte_source&lt;data_chunk&gt;&gt;;</span><br></pre></td></tr></table></figure>
<p>如何使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">data_chunk data;</span><br><span class="line"><span class="function">data_source <span class="title">istream</span><span class="params">(data)</span></span>;</span><br><span class="line">boost::<span class="function">archive::binary_iarchive <span class="title">ia</span><span class="params">(istream)</span></span>;</span><br><span class="line">istream &gt;&gt; g;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/11/2018-08-11-some-thought-about-golang-package-management/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/11/2018-08-11-some-thought-about-golang-package-management/" class="post-title-link" itemprop="url">Some thought about golang  package management</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-11 07:44:00" itemprop="dateCreated datePublished" datetime="2018-08-11T07:44:00+00:00">2018-08-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>程式語言的Package management要做好很難<br>於是就有讓人吐槽的地方，這次我們的對象就是golang<br>談談我不喜歡的兩個點吧</p>
<h3 id="Package-path"><a href="#Package-path" class="headerlink" title="Package path"></a>Package path</h3><p>當要下載相依Package的時候，預先放在<code>${GOPATH}/src</code>下<br>而不適放在Repository個某的目錄底下，這種方式我不喜歡<br>不喜歡的點在於<br>– 萬一修改了相依package的程式碼，而沒在Repository沒看到任何修改，忘記這件事的機率還蠻大的<br>– 如果修改了相依Package的程式碼，想要Send Request給Pacagage的Maintainer，但是對方不接受，於是要自己Fork出一份，這就遇到產生另外一個問題</p>
<h3 id="import-url-issue"><a href="#import-url-issue" class="headerlink" title="import url issue"></a>import url issue</h3><p>在golang的世界隨處可見</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/xxx/yyy"</span></span><br></pre></td></tr></table></figure>
<p>這樣的程式碼，當你決定要Fork出自己的Pacakge之後<br>可能就變成</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"github.com/zzz/yyy"</span></span><br></pre></td></tr></table></figure>
<p>所有上面的程式碼都要跟著改掉，非常冗餘的資訊<br>一次commit就修改所有一模一樣的import path<br><a href="https://github.com/golang/go/issues/20883" target="_blank" rel="noopener">Relative imports</a><br>這提案還在討論，不過我想通過的機會也不大</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          
<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">HungMingWu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">258</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HungMingWu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
