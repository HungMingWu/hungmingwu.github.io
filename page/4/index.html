<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="第十三號艦隊">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="第十三號艦隊">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="HungMingWu">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>第十三號艦隊</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">第十三號艦隊</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/HungMingWu" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/01/30/Issue-about-unsigned-integer-overflow-and-underflow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/30/Issue-about-unsigned-integer-overflow-and-underflow/" class="post-title-link" itemprop="url">Issue about unsigned integer overflow and underflow</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-30 13:30:06" itemprop="dateCreated datePublished" datetime="2022-01-30T13:30:06+00:00">2022-01-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>過年前要生產出一些東西出來，不然太久沒寫文章了<br>看到Unsigned integer overflow和underflow造成的問題，覺得Rust的解法實在很好，在編譯時就能檢查出來</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#![deny(clippy::integer_arithmetic)]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> std::env;</span><br><span class="line"><span class="keyword">const</span> PAGE_SIZE: <span class="built_in">u64</span> = <span class="number">4096</span>;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> args: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt; = env::args().skip(<span class="number">1</span>).collect();</span><br><span class="line">    <span class="keyword">let</span> size: <span class="built_in">u64</span> = args[<span class="number">0</span>].parse().unwrap();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">"(&#123;&#125; - 2 - &#123;&#125;) =&gt; &#123;&#125;"</span>, PAGE_SIZE, size, PAGE_SIZE - <span class="number">2</span> - size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然後安裝<code>clippy</code>當作cargo的subcommand</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ cargo clippy</span><br><span class="line">error: <span class="built_in">integer</span> arithmetic detected</span><br><span class="line"> --&gt; src/main.rs:8:54</span><br><span class="line">  |</span><br><span class="line">8 |     println!(<span class="string">"(&#123;&#125; - 2 - &#123;&#125;) =&gt; &#123;&#125;"</span>, PAGE_SIZE, size, PAGE_SIZE - 2 - size);</span><br><span class="line">  |                                                      ^^^^^^^^^^^^^^^^^^^^</span><br><span class="line">  |</span><br></pre></td></tr></table></figure>
<p>如果要正確的處理，程式碼大概是這樣</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">foo</span></span>(len: <span class="built_in">u64</span>, size: <span class="built_in">u64</span>) &#123;</span><br><span class="line">  <span class="keyword">match</span> (PAGE_SIZE - <span class="number">2</span>).checked_sub(size) &#123;</span><br><span class="line">      <span class="literal">Some</span>(capacity) <span class="keyword">if</span> len &gt; capacity =&gt; &#123;</span><br><span class="line">          <span class="built_in">println!</span>(<span class="string">"no capacity left"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="literal">Some</span>(capacity) =&gt; &#123;</span><br><span class="line">          <span class="built_in">println!</span>(<span class="string">"sufficient capacity &#123;&#125;"</span>, capacity);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="literal">None</span> =&gt; &#123;</span><br><span class="line">          <span class="built_in">println!</span>(<span class="string">"underflow! bad user input!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>等價的C語言表示方法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UINT_SUB_UNDERFLOW(x, y) ((x) - (y) &gt; (x))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UINT_ADD_OVERFLOW(x, y) ((x) + (y) &lt; (x))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UINT_MUL_OVERFLOW(x, y, size_max) ((x) &amp;&amp; (y) &gt; (size_max) / (x))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE 4096u</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> len, <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">size</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (IS_UINT_SUB_UNDERFLOW(PAGE_SIZE - <span class="number">2</span>, <span class="built_in">size</span>)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"underflow! bad user input!\n"</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> capacity = PAGE_SIZE - <span class="number">2</span> - <span class="built_in">size</span>;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; capacity) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"no capacity left\n"</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"sufficient capacity %u\n"</span>, capacity);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不過這需要CPU實作Modular arithmetic而不是Saturation arithmetic</p>
<p>不然還是有像<a href="https://github.com/google/integers" target="_blank" rel="noopener">Integers</a>)這樣的第三方library，不過易用性就不如Rust了</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p>– <a href="https://frehberg.com/2022/01/rust-detect-unsigned-integer-underflow/" target="_blank" rel="noopener">Rust: detect unsigned integer underflow</a></p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Saturation_arithmetic" target="_blank" rel="noopener">Saturation arithmetic</a></li>
<li><a href="https://en.wikipedia.org/wiki/Modular_arithmetic" target="_blank" rel="noopener">Modular arithmetic</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/11/20/Refelection-in-C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/11/20/Refelection-in-C/" class="post-title-link" itemprop="url">Refelection in C++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-11-20 17:47:56" itemprop="dateCreated datePublished" datetime="2021-11-20T17:47:56+00:00">2021-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="Why-Refelection"><a href="#Why-Refelection" class="headerlink" title="Why Refelection"></a>Why Refelection</h3><p>有些時候，我們需要遍歷struct/class的member，最常見的的用途就是print/serialization/deserialization</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obj</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">const</span> obj&amp; o)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, o.a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這樣子的做法雖然直接，不過有幾個問題</p>
<ul>
<li>只要structure改變，你的implementation就要跟著改變</li>
<li>假設要一直支持新的structure，我們需要一個新的overload function</li>
</ul>
<p>另外有時候我們也需要 struct field name的資訊，例如我們想知道struct file的名稱，而Compiler編譯出來的程式碼沒有struct/class的field資訊，所以我們會這樣手動寫死</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">const</span> obj&amp; o)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"a: %d\n"</span>, o.a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我們把a名稱改成a1，也是要手動維護程式碼，那有什麼適合的方案嗎</p>
<h3 id="Compilier-dependent-solution"><a href="#Compilier-dependent-solution" class="headerlink" title="Compilier dependent solution"></a>Compilier dependent solution</h3><p>clang的<code>__builtin_dump_struct</code><br>只支援dump功能，其他沒了，也只有clang能用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obj1</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">obj1</span> <span class="title">o</span> = &#123;</span> .a=<span class="number">1</span>, .b=<span class="number">2</span> &#125;;</span><br><span class="line">    __builtin_dump_struct(&amp;o, &amp;<span class="built_in">printf</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Wrong-Idea"><a href="#Wrong-Idea" class="headerlink" title="Wrong Idea"></a>Wrong Idea</h3><p>想到最直覺的方法，當然是這樣寫</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print</span><span class="params">(<span class="keyword">const</span> T&amp; o)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; field : &#123; field of o &#125;)</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; field &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不過眾所周知，for loop不能這樣用</p>
<h3 id="Boost-pfr-for-resuce"><a href="#Boost-pfr-for-resuce" class="headerlink" title="Boost pfr for resuce"></a>Boost pfr for resuce</h3><p>山不轉路轉，有無數的聰明人想出了方法，其中最有名的就是<code>boost pfr</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;boost&#x2F;pfr&#x2F;ops.hpp&gt;</span><br><span class="line">template &lt;typename T&gt;</span><br><span class="line">void print(const T&amp; o)</span><br><span class="line">&#123;</span><br><span class="line">    boost::pfr::for_each_field(o, [&amp;](const auto&amp; v) &#123;</span><br><span class="line">        std::cout &lt;&lt; v &lt;&lt; &quot;\n&quot;;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不過這方法也是有其侷限性</p>
<ul>
<li>增加了對 <code>boost pfr</code>的依賴</li>
<li>只能對Aggregate type使用</li>
<li>不能解決field name的問題<h3 id="nameof"><a href="#nameof" class="headerlink" title="nameof"></a>nameof</h3>一個借鑑於C#的library<br>大概的用法是這樣子<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">NAMEOF(somevar) -&gt; <span class="string">"somevar"</span></span><br><span class="line">NAMEOF(person.address.zip_code) -&gt; <span class="string">"zip_code"</span></span><br></pre></td></tr></table></figure>
對單一變數效果還行，不過對struct/class裡面的field name還是無能為力</li>
</ul>
<h3 id="Macro-based-Solution"><a href="#Macro-based-Solution" class="headerlink" title="Macro based Solution"></a>Macro based Solution</h3><p>以Boost Hana為例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;boost/hana.hpp&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">OrderedItem</span> &#123;</span></span><br><span class="line">    BOOST_HANA_DEFINE_STRUCT(</span><br><span class="line">            OrderedItem,</span><br><span class="line">            (<span class="built_in">std</span>::<span class="built_in">string</span>, item_name),</span><br><span class="line">            (<span class="keyword">int64_t</span>, quantity),</span><br><span class="line">            (<span class="keyword">int64_t</span>, price_cents)</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">boost::<span class="function">json::value <span class="title">FormatStructure</span><span class="params">(<span class="keyword">const</span> T &amp;t)</span> </span>&#123;</span><br><span class="line">    boost::json::object result;</span><br><span class="line">    boost::hana::for_each(t, boost::hana::fuse([&amp;result](<span class="keyword">auto</span> name, <span class="keyword">auto</span> member) &#123;</span><br><span class="line">        result.emplace(boost::hana::to&lt;<span class="keyword">const</span> <span class="keyword">char</span> *&gt;(name), FormatObject(member));</span><br><span class="line">    &#125;));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">boost::<span class="function">json::value <span class="title">FormatObject</span><span class="params">(<span class="keyword">const</span> T &amp;t)</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">if</span> <span class="title">constexpr</span> <span class="params">(boost::hana::Struct&lt;T&gt;::value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> internal::FormatStructure(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> internal::FormatValue(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>光看程式碼就猜的到，<code>BOOST_HANA_DEFINE_STRUCT</code>做了很多事情，維護每個除了原先的 field declaration之外，還維護了field name的資訊<br>不過Macro就是黑魔法，維護起來就是麻煩，不過現階段也沒更好的方法</p>
<h3 id="Runtime-Refelection"><a href="#Runtime-Refelection" class="headerlink" title="Runtime Refelection"></a>Runtime Refelection</h3><p>上面說的都是Compile-time Refelection，當然還有一派作法是在Runtime時做Refelection，能無視編譯器的差異，提供比編譯器更多的Metadata，不過這一切都是要手動做</p>
<p>不管Compile-time Refelectionc還是Runtime Refelection，都掙脫不了Macro和Template的禁錮</p>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>有個實驗性質的<code>reflection TS</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">S</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> b;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span> s;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">string</span>&gt; v;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Reflection TS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;experimental/reflect&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> meta_S = reflexpr(S);</span><br><span class="line"><span class="keyword">using</span> mem = <span class="built_in">std</span>::reflect::<span class="keyword">get_data_members_t</span>&lt;meta_S&gt;;</span><br><span class="line"><span class="keyword">using</span> meta = <span class="built_in">std</span>::reflect::<span class="keyword">get_data_members_t</span>&lt;mem&gt;;</span><br></pre></td></tr></table></figure>
<p>不過前途未卜啊，搞不好像NetworkTS那樣推倒重來，C++23是無望了</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://boost.org/libs/pfr" target="_blank" rel="noopener">Boost.PFR</a></li>
<li><a href="https://github.com/Neargye/nameof" target="_blank" rel="noopener">nameof</a></li>
<li><a href="https://blog.askesis.pl/post/2020/12/cpp-metaprogramming.html" target="_blank" rel="noopener" title="Permalink to How far can you take C++ metaprogramming">How far can you take C++ metaprogramming</a></li>
<li><a href="https://preshing.com/20180116/a-primitive-reflection-system-in-cpp-part-1/" target="_blank" rel="noopener">A Flexible Reflection System in C++: Part 1</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/10/25/Structure-of-Array-in-C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/10/25/Structure-of-Array-in-C/" class="post-title-link" itemprop="url">Structure of Array in C++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-25 22:06:45" itemprop="dateCreated datePublished" datetime="2021-10-25T22:06:45+00:00">2021-10-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="What-is-array-of-structure"><a href="#What-is-array-of-structure" class="headerlink" title="What is array of structure"></a>What is array of structure</h3><p>這就是我們一般常用的模式</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Obj</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> a, b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">array</span>&lt;Obj, 100&gt; objs;</span><br></pre></td></tr></table></figure>

<h3 id="What-is-structure-of-array"><a href="#What-is-structure-of-array" class="headerlink" title="What is structure of array"></a>What is structure of array</h3><p>剛好和上面的觀念相反，將object的member集中在一起，以上面的例子來說，可以寫成這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">int</span>, 100&gt;, <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">int</span>, 100&gt;&gt; objs;</span><br></pre></td></tr></table></figure>

<h3 id="Why-structure-of-array"><a href="#Why-structure-of-array" class="headerlink" title="Why structure of array"></a>Why structure of array</h3><p>從上面兩個寫法看來，<code>array of structure</code>更為自然，容易咧解<br>那為什麼會有<code>structure of array</code>的出現，<strong>一切都是為了性能</strong><br>例如這樣子的Code</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> v : objs)</span><br><span class="line">	sum += v.a;</span><br></pre></td></tr></table></figure>
<p>由於CPU locality特性，a的stride是<code>sizeof(Obj)</code>大小，所以CPU Cache幾乎沒有作用<br>但如果寫成這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> sum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">auto</span> &amp;as = <span class="built_in">std</span>::get&lt;<span class="number">0</span>&gt;(objs);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> v : as)</span><br><span class="line">	sum += v;</span><br></pre></td></tr></table></figure>

<p>由於<code>std::array&lt;int, 100&gt;</code>是個連續的memory area，因此在CPU locality方面比起上面方案好<br>不過有一好沒兩好<br><code>structure of array</code>的缺點有</p>
<ul>
<li>程式碼不容易讀</li>
</ul>
<h3 id="How-to-use-struct-of-array-in-C"><a href="#How-to-use-struct-of-array-in-C" class="headerlink" title="How to use struct of array in C++"></a>How to use struct of array in C++</h3><p>由於C++沒有原生的SOA支援，有第三方的Library供使用</p>
<ul>
<li><p><a href="https://github.com/Yamahari/struct_array" target="_blank" rel="noopener">struct_array</a><br>不過用起來很彆扭，如果真的不是真的效能至上，還是用原先的寫法吧</p>
</li>
<li><p><a href="https://github.com/celtera/ahsohtoa" target="_blank" rel="noopener">ahsohtoa - automatic AoS-to-SoA</a><br>這個不錯，不過需要Boost PFR和C++20</p>
</li>
<li><p><a href="https://godbolt.org/z/8Yxd4Ed1q" target="_blank" rel="noopener">Boost Describe based Solution</a><br>不需要C++20，不過還是得要Boost Describe</p>
</li>
</ul>
<p>不過C++ Refelction何時落地啊</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/30/Projection-in-C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/30/Projection-in-C/" class="post-title-link" itemprop="url">Projection in C++</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-30 10:51:09" itemprop="dateCreated datePublished" datetime="2021-09-30T10:51:09+00:00">2021-09-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>雖然之前有看過，不過看過即忘，還是得寫下來</p>
<h3 id="What’s-projection"><a href="#What’s-projection" class="headerlink" title="What’s projection"></a>What’s projection</h3><p>從一個寫到爛的範例開始</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">	<span class="built_in">std</span>::<span class="built_in">string</span> name;</span><br><span class="line">	<span class="keyword">int</span> age;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Person&gt; persons;</span><br><span class="line"><span class="built_in">std</span>::sort(begin(persons), end(persons), [](<span class="keyword">const</span> <span class="keyword">auto</span>&amp; p1, <span class="keyword">const</span> <span class="keyword">auto</span>&amp; p2) &#123;</span><br><span class="line">	<span class="keyword">return</span> p1.name &lt; p2.name;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>相信這樣的程式碼已經寫到吐了<br>如果用C++20 Ranges寫的話可以這樣寫</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::ranges::sort(persons, <span class="built_in">std</span>::ranges::less&#123;&#125;, &amp;Person::name);</span><br></pre></td></tr></table></figure>
<p>可以知道我們要比的就是name，而這樣的寫法就叫做<code>Projection</code></p>
<h3 id="Backport-to-C-17"><a href="#Backport-to-C-17" class="headerlink" title="Backport to C++17"></a>Backport to C++17</h3><p>其實要backport到更之前的版本也行， 只要有<a href="https://github.com/BlackMATov/invoke.hpp" target="_blank" rel="noopener">第三方</a>或是自己寫的invoke<br>然後寫一個projecting_fn functor，compose以下的操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> Function, <span class="keyword">typename</span> Projection&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">projecting_fn</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    projecting_fn(Function function, Projection projection)</span><br><span class="line">        : m_function&#123; <span class="built_in">std</span>::move(function) &#125;</span><br><span class="line">        , m_projection&#123; <span class="built_in">std</span>::move(projection) &#125;</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">template</span> &lt;<span class="keyword">typename</span>... Args&gt;</span><br><span class="line">    <span class="function"><span class="keyword">decltype</span>(<span class="keyword">auto</span>) <span class="title">operator</span><span class="params">()</span> <span class="params">(Args&amp;&amp;... args)</span> <span class="keyword">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">std</span>::invoke(</span><br><span class="line">            m_function,</span><br><span class="line">            <span class="built_in">std</span>::invoke(m_projection, <span class="built_in">std</span>::forward&lt;<span class="keyword">decltype</span>(args)&gt;(args))...);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Function m_function;</span><br><span class="line">    Projection m_projection;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">std</span>::sort(begin(persons), end(persons),</span><br><span class="line">     projecting_fn&#123; <span class="built_in">std</span>::less&#123;&#125;, &amp;Person::name &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="Projection-and-view-filter"><a href="#Projection-and-view-filter" class="headerlink" title="Projection and view filter"></a>Projection and view filter</h3><p>像這樣的Source Code是無法通過編譯的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">LessThan</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">operator</span><span class="params">()</span><span class="params">(<span class="keyword">const</span> T&amp; x)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x &lt; value;</span><br><span class="line">    &#125;</span><br><span class="line">    T value;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Apple</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> weight;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> apples = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Apple&gt;&#123;&#123;<span class="number">1</span>,<span class="number">2</span>&#125;, &#123;<span class="number">2</span>,<span class="number">3</span>&#125;, &#123;<span class="number">3</span>,<span class="number">4</span>&#125;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> smallApples = apples | views::filter(LessThan&#123;<span class="number">3</span>&#125;, &amp;Apple::size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解決方式有兩種</p>
<h4 id="不用Projection也是一種解決方法"><a href="#不用Projection也是一種解決方法" class="headerlink" title="不用Projection也是一種解決方法"></a>不用Projection也是一種解決方法</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apples | views::filter([] (Apple&amp; a) &#123;<span class="keyword">return</span> a.size &lt; <span class="number">3</span>;&#125;)</span><br></pre></td></tr></table></figure>
<p>不過這方式就與本文無關了</p>
<h4 id="Boost-HOF"><a href="#Boost-HOF" class="headerlink" title="Boost HOF"></a>Boost HOF</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apples | views::filter(hof::proj(&amp;Apple::size, LessThan&#123;<span class="number">3</span>&#125;));</span><br></pre></td></tr></table></figure>
<p>這方法就類似上面C++17的projecting_fn</p>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://ezoeryou.github.io/blog/article/2019-01-22-ranges-projection.html" target="_blank" rel="noopener">Projection, a powerful feature in C++20 Ranges library </a></li>
<li><a href="https://cukic.co/2019/01/22/projections-without-ranges/" target="_blank" rel="noopener">C++17 projections even without ranges</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/09/12/Cross-Platform-Testing-on-single-machine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/09/12/Cross-Platform-Testing-on-single-machine/" class="post-title-link" itemprop="url">Cross Platform Testing on single machine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-09-12 19:40:55" itemprop="dateCreated datePublished" datetime="2021-09-12T19:40:55+00:00">2021-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>寫網路程式，Big / Little endian轉換是逃不了的問題，不過Big Endian的機器又難找</p>
<p>找到的資料又舊，不過最近看到<a href="https://nullprogram.com/blog/2021/08/21/" target="_blank" rel="noopener">Test cross-architecture without leaving home</a>之後真是驚為天人，寫了一個<a href="https://github.com/HungMingWu/cross_test" target="_blank" rel="noopener">Template</a><br>這下子省了很多麻煩</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/08/02/Introduction-to-C-20-Module/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/02/Introduction-to-C-20-Module/" class="post-title-link" itemprop="url">Introduction to C++20 Module</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-08-02 16:12:27" itemprop="dateCreated datePublished" datetime="2021-08-02T16:12:27+00:00">2021-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/programming/" itemprop="url" rel="index"><span itemprop="name">programming</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="The-simplest-module"><a href="#The-simplest-module" class="headerlink" title="The simplest module"></a>The simplest module</h2><p>先看範例，就是Module版的Hello World</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello_world</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">non_export_func</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>而Consumer Module的一方就這樣寫</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hello;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    hello_world(); <span class="comment">// OK</span></span><br><span class="line">    non_export_func(); <span class="comment">// Cannot compile</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><p>從這個範例當中，Consumer這邊不用特別說<br>這邊要說的是如何寫個Module</p>
<h4 id="Module-Unit"><a href="#Module-Unit" class="headerlink" title="Module Unit"></a>Module Unit</h4><p>在C++20，有了一個新的Compile Unit，就是Module Unit，所有Module Unit的Top Level Statement都是有<code>module</code>關鍵字的<br>而<code>module</code>前面有沒有<code>export</code>就是決定這是哪一種Module Unit</p>
<ul>
<li>有<code>export</code>的叫作Module Interface Unit</li>
<li>無<code>export</code>的叫做Module Implementation Unit</li>
</ul>
<p>Module Implementation Unit後面再說</p>
<h4 id="The-content-of-a-module"><a href="#The-content-of-a-module" class="headerlink" title="The content of a module"></a>The content of a module</h4><p>一個Module擁有</p>
<ul>
<li>一個以上的Module Interface Unit</li>
<li>零個以上的Module Implementation Unit</li>
</ul>
<p>且每個Module裡面<strong>有且唯一</strong>一個Primary Module Interface Unit</p>
<p>在Hello World這個範例當然只有<code>Primary Module Interface Unit</code> 的存在，至於什麼是Primary Module Interface Unit，也是後面再說</p>
<h4 id="export"><a href="#export" class="headerlink" title="export"></a>export</h4><p>在上面的範例，我們定義了兩個函數</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello_world</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">non_export_func</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>不塗於傳統的header file方式，如果是傳統的header file，兩個function應該都可以被外界可見，而Module Unit只有<code>export</code>出的符號才能輩Connsumer看到<br>export的其他用法還有這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// export entire namespace</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">namespace</span> hello &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export the symbols in the block</span></span><br><span class="line"><span class="keyword">export</span> &#123;</span><br><span class="line">	<span class="keyword">int</span> e = <span class="number">1</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Module-Implementation-Unit"><a href="#Module-Implementation-Unit" class="headerlink" title="Module Implementation Unit"></a>Module Implementation Unit</h4><p>就像傳統<code>header/implementation</code>的方法，我們可以把<code>declaration/implementation</code>分離，因此我們有了<code>Module Implementation Unit</code><br>重寫我們的範例，將implementation分開<br>因此我們的Module Interface Unit就變成</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello_world</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">non_export_func</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>
<p>而Module Implementation Unit則是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> hello;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">hello_world</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">non_export_func</span><span class="params">()</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>如同之前所說的，module前面沒加<code>export</code>的就是Module Implementation Unit，而在function implementation前面也沒加<code>export</code>，就跟傳統的方式很像</p>
<h4 id="My-thought-on-Module-Implementation-Unit"><a href="#My-thought-on-Module-Implementation-Unit" class="headerlink" title="My thought on Module Implementation Unit"></a>My thought on Module Implementation Unit</h4><p>之前<code>declaration/implementation</code>被人詬病的一點，就是你要維護兩份狀態，當你declaration改了之後，如果implementation沒改，會產生不可預料的後果，運氣好的話是編譯不過，運氣不好產生深層的Bug更難解</p>
<p>如同之前所說的，一個Module可以不必擁有<code>Module Implementation Unit</code><br>那存在的必要是什麼？</p>
<p>我認為是將舊有的Source Code Mitigation到C++ Module的方式<br>如同現在流行的<code>header only library</code>一樣，未來的Module應該僅由Module Interface Unit組成</p>
<h3 id="Import-other-module"><a href="#Import-other-module" class="headerlink" title="Import other module"></a>Import other module</h3><p>寫Module時不免使用到其他Module，讓我們定義一個新的Module</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> world;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">struct</span> <span class="title">obj</span> &#123;</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>而我們的hello module就變成這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br><span class="line"><span class="keyword">import</span> world;</span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello_world</span><span class="params">(obj o)</span> </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>注意，import只能放在top level module declaration之下，不能交換順序</p>
<p>接著要回去看Consumer的部分了</p>
<h3 id="Visibility-control"><a href="#Visibility-control" class="headerlink" title="Visibility control"></a>Visibility control</h3><p>此時我們的Consumer會是這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hello;</span><br><span class="line"><span class="keyword">import</span> world;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        obj o;</span><br><span class="line">        hello_world(o);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這裡該注意的點，在hello module當中雖然import了world，但是不<br>會再次輸出symbol到hello module metadata中<br>因此如果Consumer沒加上<code>import world</code>時，會發現找不到obj的情形</p>
<p>但如果我們將hello改成這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">import</span> world;</span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello_world</span><span class="params">(obj o)</span> </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>這邊將我們import進來的Module再度export出去，這也是我們細分module的基礎<br>那麼Consumer不加<code>import world</code>也是可以正常運行</p>
<h3 id="Divide-module-into-small-parts"><a href="#Divide-module-into-small-parts" class="headerlink" title="Divide module into small parts"></a>Divide module into small parts</h3><p>當一個Module大起來之後，要降低複雜度，細分成更小的Block是需要的，而其中又有兩種方法</p>
<h4 id="Sobmodule"><a href="#Sobmodule" class="headerlink" title="Sobmodule"></a>Sobmodule</h4><p>我們將hello_world分成兩個function<br>一個放在<code>hello.sub_a</code>，另外一個放在<code>hello.sub_b</code><br>直接看程式碼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello.sub_a;</span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>而另外一個就不貼了，看看我們hello module的定義</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">import</span> hello.sub_a;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">import</span> hello.sub_b;</span><br></pre></td></tr></table></figure>

<p>Reexport出<code>hello.sub_a</code>和<code>hello.sub_b</code>的exported symbol</p>
<h4 id="Note"><a href="#Note" class="headerlink" title="Note"></a>Note</h4><p><code>hello.sub_a</code>和<code>hello_sub_b</code>是各自獨立完整的Module，submodule機制只是<strong>邏輯</strong>組合，讓他們看起來像是同一個Module<br>所以你Consumer這樣寫也是可以的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hello.sub_a;</span><br><span class="line"><span class="keyword">import</span> hello.sub_b;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        hello();</span><br><span class="line">        world();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Module-partition"><a href="#Module-partition" class="headerlink" title="Module partition"></a>Module partition</h3><p>不同於submodule，partition所分的sub partition不能個別存在<br>一樣直接看程式碼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello:part_a;</span><br><span class="line"><span class="function"><span class="keyword">export</span> <span class="keyword">void</span> <span class="title">hello</span><span class="params">()</span> </span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p>跟上面很像，不過將<code>.</code>改成了<code>:</code><br>而我們的hello module則是</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">import</span> :part_a;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">import</span> :part_b;</span><br></pre></td></tr></table></figure>
<p>這邊有幾點要注意的</p>
<ul>
<li><p>一個module name當中沒有<code>:</code>出現的就是<code>Primary Module Interface Unit</code>，如同之前所說<br>一個以上的Module Interface Unit，<strong>有且唯一</strong>一個Primary Module Interface Unit<br>這個範例有三個Module Interface Unit，只有hello是Primary Module Interface Unit<br>而<code>hello.sub_a</code>則是一個獨立的Module，只是<strong>邏輯上</strong>看起來是同一個Mdoule</p>
</li>
<li><p>Partition只能接受<code>import :part_a</code>的語法，<code>import hello:part_a</code>是不對的</p>
</li>
<li><p>Consumer只能寫<code>import hello</code>了</p>
</li>
</ul>
<h3 id="Global-Module-Fragment"><a href="#Global-Module-Fragment" class="headerlink" title="Global Module Fragment"></a>Global Module Fragment</h3><p>Global Module Fragment是提供preprocessor使用的空間，因此你可以在這邊定義Marco，或是include未被moduleized的header file，而在這邊定義的symbol則不會輸出到module interface中，因此不會汙染全局環境</p>
<p>Global Module Fragment必須在<code>export module</code>之前，就像這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX(a, b) (((a) &gt; (b)) ? (a) : (b))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">module</span> hello;</span><br></pre></td></tr></table></figure>

<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://meetingcpp.com/mcpp/slides/2019/modules-the-beginners-guide-meetingcpp2019.pdf" target="_blank" rel="noopener">Meeting C++ 2019, Modules - The Beginner’s Guide</a></li>
<li><a href="https://meetingcpp.com/mcpp/slides/2019/modules_are_coming__r3__2019__meeting_cpp2379.pdf" target="_blank" rel="noopener">Meeting C++ 2019, Modules are Coming</a></li>
<li><a href="https://vector-of-bool.github.io/2019/03/10/modules-1.html" target="_blank" rel="noopener">Understanding C++ Modules: Part 1: Hello Modules, and Module Units</a></li>
<li><a href="https://vector-of-bool.github.io/2019/03/31/modules-2.html" target="_blank" rel="noopener">Understanding C++ Modules: Part 2: export, import, visible, and reachable </a></li>
<li><a href="https://vector-of-bool.github.io/2019/10/07/modules-3.html" target="_blank" rel="noopener">Understanding C++ Modules: Part 3: Linkage and Fragments </a></li>
<li><a href="https://mp.weixin.qq.com/s?__biz=MzI1NTMwNDg3MQ==&mid=2247487982&idx=1&sn=5fc155d712ae0da23606df8424f3f160" target="_blank" rel="noopener">C++20 四大特性之一：Module 特性详解 </a></li>
<li><a href="https://zhuanlan.zhihu.com/p/373457208" target="_blank" rel="noopener">Modules</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/350136757" target="_blank" rel="noopener">C++20 新特性: modules 及实现现状</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/15/Write-a-synchronize-API-based-on-ASIO-asynchronous-operation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/15/Write-a-synchronize-API-based-on-ASIO-asynchronous-operation/" class="post-title-link" itemprop="url">Write a synchronize API based on ASIO asynchronous operation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-07-15 08:03:26" itemprop="dateCreated datePublished" datetime="2021-07-15T08:03:26+00:00">2021-07-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>基本上這個要求蠻奇怪的，ASIO又不是沒提供Synchronize API，不過有些事情就是只有Asynchronous API能做到<br>例如我要在五秒鐘之內連線，五秒鐘之內無法連上就直接結束，如果用Synchronize API，Timeout由作業系統決定<br>這個時候就只有自己寫了</p>
<h3 id="use-future"><a href="#use-future" class="headerlink" title="use_future"></a>use_future</h3><p>ASIO有一個feature，可以將Async operation轉成Sync operation<br>一般來說我們的程式碼會寫成這樣</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">socket.async_connect(endpoint, [](<span class="built_in">std</span>::error_code ec) &#123;</span><br><span class="line">	<span class="comment">// blablabla</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>但是如果我們用<code>use_future</code>的話，ASIO內部會自己轉成promise/future的Pattern<br>這適合在Threead synchronize的情景使用</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">asio::io_context ctx;</span><br><span class="line">asio::ip::<span class="function">tcp::socket <span class="title">socket</span><span class="params">(ctx)</span></span>;</span><br><span class="line"><span class="keyword">auto</span> <span class="built_in">future</span> = socket.async_connect(endpoint, asio::use_future);</span><br><span class="line"><span class="function"><span class="built_in">std</span>::thread <span class="title">t</span><span class="params">([&amp;] &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">	ctx.run();</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;)</span></span>;</span><br><span class="line"><span class="built_in">future</span>.get();</span><br></pre></td></tr></table></figure>

<h3 id="Combie-with-C-20-Coroutine"><a href="#Combie-with-C-20-Coroutine" class="headerlink" title="Combie with C++20 Coroutine"></a>Combie with C++20 Coroutine</h3><p>如果我們的條件更複雜，如一開始寫的五秒鐘Timeout這件事，上面的程式碼就不敷使用，<br>如果用原先的Function callback方式寫大概會死一堆腦細胞，而Coroutine可以讓我們大大減輕心智負擔</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asio::awaitable&lt;<span class="keyword">void</span>&gt; <span class="title">timeout</span><span class="params">(<span class="built_in">std</span>::chrono::seconds seconds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="function">asio::steady_timer <span class="title">timer</span><span class="params">(<span class="keyword">co_await</span> asio::this_coro::executor)</span></span>;</span><br><span class="line">	timer.expires_after(seconds);</span><br><span class="line">	<span class="keyword">co_await</span> timer.async_wait(use_nothrow_awaitable);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">asio::awaitable&lt;<span class="built_in">std</span>::error_code&gt; <span class="title">connect_with_timeout</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">	asio::ip::tcp::socket&amp; socket,</span></span></span><br><span class="line"><span class="function"><span class="params">	<span class="keyword">const</span> asio::ip::tcp::endpoint&amp; endpoint)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">using</span> <span class="keyword">namespace</span> asio::experimental::awaitable_operators;</span><br><span class="line">	<span class="keyword">auto</span> result = <span class="keyword">co_await</span>(</span><br><span class="line">		socket.async_connect(endpoint, use_nothrow_awaitable) ||</span><br><span class="line">		timeout(<span class="built_in">std</span>::chrono::seconds(<span class="number">5</span>))</span><br><span class="line">	);</span><br><span class="line">	<span class="keyword">if</span> (result.index() == <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">co_return</span> asio::error::timed_out; <span class="comment">// timed out</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">auto</span> [r] = <span class="built_in">std</span>::get&lt;<span class="number">0</span>&gt;(result);</span><br><span class="line">	<span class="keyword">co_return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asio::io_context io_context;</span><br><span class="line"><span class="keyword">auto</span> connect_future = asio::co_spawn(</span><br><span class="line">    io_context.get_executor(),</span><br><span class="line">	connect_with_timeout(asio::ip::tcp::socket(io_context), endpoint), </span><br><span class="line">	asio::use_future);</span><br><span class="line">io_context.run();</span><br><span class="line"><span class="keyword">return</span> connect_future.get();</span><br></pre></td></tr></table></figure>

<p>如上面程式碼寫的一樣<br>在<code>connect_with_timeout</code>有兩種可能，一個是socket connect的結果，另外一個是timeout<br>asio::co_spawn的最後一個參數不是教學中的<code>detach</code>，而是剛剛講的<code>use_future</code><br>這樣子就可以把Coroutine 和 promise/future一起使用</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/05/eBPF-and-bcc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/05/eBPF-and-bcc/" class="post-title-link" itemprop="url">eBPF and bcc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-05 16:51:54" itemprop="dateCreated datePublished" datetime="2021-06-05T16:51:54+00:00">2021-06-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>eBPF和bcc的介紹文件已經有不少了，多寫介紹實在是浪費資源<br>直接紀錄架構和該怎麼用，先有個概念，日後如果有需要的話再仔細研究</p>
<h3 id="The-artitecture-of-eBPF"><a href="#The-artitecture-of-eBPF" class="headerlink" title="The artitecture of eBPF"></a>The artitecture of eBPF</h3><p>一圖勝千文<br><img src="http://www.brendangregg.com/eBPF/linux_ebpf_internals.png" alt=""></p>
<h3 id="What-is-bcc"><a href="#What-is-bcc" class="headerlink" title="What is bcc?"></a>What is bcc?</h3><ul>
<li>由於直接編寫eBPF難度很高，bcc提供了一個Python library，簡化eBPF的開發過程</li>
<li>bcc也納入了很多可以直接拿來用的Application</li>
</ul>
<p>以下是bcc Tracking Tools的示意圖<br><img src="http://www.brendangregg.com/Perf/bcc_tracing_tools.png" alt=""></p>
<h3 id="Write-a-bcc-program"><a href="#Write-a-bcc-program" class="headerlink" title="Write a bcc program"></a>Write a bcc program</h3><p>只是個Hello World的範例</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> bcc <span class="keyword">import</span> BPF</span><br><span class="line"><span class="keyword">from</span> bcc.utils <span class="keyword">import</span> printb</span><br><span class="line"></span><br><span class="line"><span class="comment"># define BPF program</span></span><br><span class="line">prog = <span class="string">"""</span></span><br><span class="line"><span class="string">int hello(void *ctx) &#123;</span></span><br><span class="line"><span class="string">    bpf_trace_printk("Hello, World!\\n");</span></span><br><span class="line"><span class="string">    return 0;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># load BPF program</span></span><br><span class="line">b = BPF(text=prog)</span><br><span class="line">b.attach_kprobe(event=b.get_syscall_fnname(<span class="string">"clone"</span>), fn_name=<span class="string">"hello"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># header</span></span><br><span class="line">print(<span class="string">"%-18s %-16s %-6s %s"</span> % (<span class="string">"TIME(s)"</span>, <span class="string">"COMM"</span>, <span class="string">"PID"</span>, <span class="string">"MESSAGE"</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># format output</span></span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        (task, pid, cpu, flags, ts, msg) = b.trace_fields()</span><br><span class="line">    <span class="keyword">except</span> ValueError:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        exit()</span><br><span class="line">    printb(<span class="string">b"%-18.9f %-16s %-6d %s"</span> % (ts, task, pid, msg))</span><br></pre></td></tr></table></figure>

<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a href="https://ebpf.io/" target="_blank" rel="noopener">ebpf.io</a></li>
<li><a href="https://docs.cilium.io/en/stable/bpf/" target="_blank" rel="noopener">BPF and XDP Reference Guide</a></li>
<li><a href="https://www.kernel.org/doc/html/latest/bpf/bpf_devel_QA.html" target="_blank" rel="noopener">HOWTO interact with BPF subsystem</a></li>
<li><a href="https://github.com/DavadDi/bpf_study" target="_blank" rel="noopener">eBPF 技术简介</a></li>
<li><a href="https://github.com/nevermosby/linux-bpf-learning" target="_blank" rel="noopener">学习Linux BPF/eBPF 编程</a></li>
<li><a href="http://www.brendangregg.com/ebpf.html" target="_blank" rel="noopener">Linux Extended BPF (eBPF) Tracing Tools</a></li>
<li><a href="https://github.com/iovisor/bcc" target="_blank" rel="noopener">bcc</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md" target="_blank" rel="noopener">bcc Python Developer Tutorial</a></li>
<li><a href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md" target="_blank" rel="noopener">bcc Reference Guide</a></li>
</ul>
<h3 id="書籍"><a href="#書籍" class="headerlink" title="書籍"></a>書籍</h3><ul>
<li><a href="https://www.oreilly.com/library/view/linux-observability-with/9781492050193/" target="_blank" rel="noopener">Linux Observability with BPF</a></li>
<li><a href="http://www.brendangregg.com/bpf-performance-tools-book.html" target="_blank" rel="noopener">BPF Performance Tools</a></li>
<li><a href="http://www.brendangregg.com/systems-performance-2nd-edition-book.html" target="_blank" rel="noopener">Systems Performance: Enterprise and the Cloud, 2nd Edition</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/01/Empty-struct-empty-value-and-no-unique-address/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/01/Empty-struct-empty-value-and-no-unique-address/" class="post-title-link" itemprop="url">Empty struct, empty_value and [[no_unique_address]]</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-06-01 09:32:12" itemprop="dateCreated datePublished" datetime="2021-06-01T09:32:12+00:00">2021-06-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前遇到亂流，需要重新找工作，如今告一段落，可以寫點東西了</p>
<p>來聊聊Empty Struct的問題好了</p>
<h3 id="Empty-struct"><a href="#Empty-struct" class="headerlink" title="Empty struct"></a>Empty struct</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">empty</span> &#123;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%ld\n"</span>, <span class="keyword">sizeof</span>(struct empty)); <span class="comment">// ????</span></span><br></pre></td></tr></table></figure>
<p>這個答案有所不同<br>在C語言，印出來的情形是0<br>在C++，印出來會是1，C++為了保證不同的Object的Address不同，就算是empty struct， sizeof也不為空</p>
<h3 id="Embedded-empty-struct"><a href="#Embedded-empty-struct" class="headerlink" title="Embedded empty struct"></a>Embedded empty struct</h3><p>那如果是這樣呢</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">empty</span> &#123;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">non_empty</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">empty</span> <span class="title">e</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%ld\n"</span>, <span class="keyword">sizeof</span>(struct non_empty)); <span class="comment">// ????</span></span><br></pre></td></tr></table></figure>
<p>同樣的<br>在C語言，印出來的情形是4<br>在C++，印出來當然不會是4，在我的ubuntu 64bit印出來是8</p>
<h3 id="Why-use-empty-struct"><a href="#Why-use-empty-struct" class="headerlink" title="Why use empty struct"></a>Why use empty struct</h3><p>在C語言的應用情景，empty struct沒有任何用途<br>可是在C++的世界裡面，empty struct可以是個functor<br>例如<code>std::less</code>，<code>std::equal_to</code>之類的<br>使用template class可以將functor傳入struct裡面，因此可以擴充這個class的功能</p>
<h3 id="How-to-reuduce-the-size"><a href="#How-to-reuduce-the-size" class="headerlink" title="How to reuduce the size"></a>How to reuduce the size</h3><p>既然有empty struct的使用場景，又不想浪費多餘的空間，所以就有人想出這樣的方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">non_empty</span> :</span> empty &#123;</span><br><span class="line">    <span class="keyword">int</span> v;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%ld\n"</span>, <span class="keyword">sizeof</span>(struct non_empty)); <span class="comment">// ????</span></span><br></pre></td></tr></table></figure>
<p>這下就如我們預料的是4了</p>
<h3 id="The-problem-of-Inherence"><a href="#The-problem-of-Inherence" class="headerlink" title="The problem of Inherence"></a>The problem of Inherence</h3><h4 id="Leak-Interface"><a href="#Leak-Interface" class="headerlink" title="Leak Interface"></a>Leak Interface</h4><p>由於Inherence有很強的傳染力，Parent class的Public API都能背Child class自由使用，因此可以寫出這樣的程式碼</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">empty</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">42</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">non_empty</span> :</span> <span class="keyword">public</span> X &#123;</span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">&#125;;</span><br><span class="line">non_empty obj;</span><br><span class="line">obj.f();</span><br></pre></td></tr></table></figure>
<p>可是我不想讓obj直接f函數…該怎麼做</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">empty</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">42</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span> :</span> empty &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">         <span class="function">empty&amp; <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">non_empty</span> :</span> <span class="keyword">public</span> X &#123;</span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">&#125;;</span><br><span class="line">non_empty obj;</span><br><span class="line">obj.get().f();</span><br></pre></td></tr></table></figure>
<p>要使用f只能透過get來做了<br>這也是<code>boost empty_value</code>在做的事情</p>
<h4 id="Hard-to-reason-sometimes"><a href="#Hard-to-reason-sometimes" class="headerlink" title="Hard to reason sometimes"></a>Hard to reason sometimes</h4><p>這也是我看了程式碼才能體會到的事情<br>以下是從<code>boost intrusive</code>中節錄的片段</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ValueTraits</span>, <span class="title">class</span> <span class="title">VoidOrKeyOfValue</span>, <span class="title">class</span> <span class="title">VoidOrKeyHash</span>, <span class="title">class</span> <span class="title">VoidOrKeyEqual</span>, <span class="title">class</span> <span class="title">BucketTraits</span>, <span class="title">class</span> <span class="title">SizeType</span>, <span class="title">std</span>:</span>:<span class="keyword">size_t</span> BoolFlags&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hashdata_internal</span></span></span><br><span class="line"><span class="class">   :</span> <span class="keyword">public</span> hashtable_size_traits_wrapper</span><br><span class="line">      &lt; <span class="keyword">bucket_hash_equal_t</span></span><br><span class="line">         &lt; ValueTraits, VoidOrKeyOfValue, VoidOrKeyHash, VoidOrKeyEqual</span><br><span class="line">         , BucketTraits</span><br><span class="line">         , <span class="number">0</span> != (BoolFlags &amp; hash_bool_flags::cache_begin_pos)</span><br><span class="line">         &gt;   <span class="comment">//2</span></span><br><span class="line">      , SizeType</span><br><span class="line">      , (BoolFlags &amp; hash_bool_flags::incremental_pos) != <span class="number">0</span></span><br><span class="line">      &gt;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">typedef</span> hashtable_size_traits_wrapper</span><br><span class="line">      &lt; <span class="keyword">bucket_hash_equal_t</span></span><br><span class="line">         &lt; ValueTraits, VoidOrKeyOfValue, VoidOrKeyHash, VoidOrKeyEqual</span><br><span class="line">         , BucketTraits</span><br><span class="line">         , <span class="number">0</span> != (BoolFlags &amp; hash_bool_flags::cache_begin_pos)</span><br><span class="line">         &gt;   <span class="comment">//2</span></span><br><span class="line">      , SizeType</span><br><span class="line">      , (BoolFlags &amp; hash_bool_flags::incremental_pos) != <span class="number">0</span></span><br><span class="line">      &gt; internal_type;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>hashtable_size_traits_wrapper依設定不同，可能是個empty struct<br>上面這段，重歷的程式碼出現了兩次，又臭又長，難以理解</p>
<h3 id="no-unique-address"><a href="#no-unique-address" class="headerlink" title="[[no_unique_address]]"></a>[[no_unique_address]]</h3><p>C++20引進了一個很有用的attribute，這告訴Compilier，不必為這個object特別分配一個Address，因此有了無限可能</p>
<h4 id="No-need-inherence"><a href="#No-need-inherence" class="headerlink" title="No need inherence"></a>No need inherence</h4><p>雲本需要用Inherence辦到的事情</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">empty</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        <span class="function"><span class="keyword">int</span> <span class="title">f</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="number">42</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">non_empty</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        [[no_unique_address]] empty e;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">        <span class="function">empty&amp; <span class="title">get</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> e; &#125;</span><br><span class="line">&#125;;</span><br><span class="line">non_empty obj;</span><br><span class="line">obj.get().f();</span><br></pre></td></tr></table></figure>

<h4 id="Fix-hard-to-reason-issue"><a href="#Fix-hard-to-reason-issue" class="headerlink" title="Fix hard to reason issue"></a>Fix hard to reason issue</h4><p>以上面那段Code來舉例</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">ValueTraits</span>, <span class="title">class</span> <span class="title">VoidOrKeyOfValue</span>, <span class="title">class</span> <span class="title">VoidOrKeyHash</span>, <span class="title">class</span> <span class="title">VoidOrKeyEqual</span>, <span class="title">class</span> <span class="title">BucketTraits</span>, <span class="title">class</span> <span class="title">SizeType</span>, <span class="title">std</span>:</span>:<span class="keyword">size_t</span> BoolFlags&gt;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hashdata_internal</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">typedef</span> hashtable_size_traits_wrapper</span><br><span class="line">      &lt; <span class="keyword">bucket_hash_equal_t</span></span><br><span class="line">         &lt; ValueTraits, VoidOrKeyOfValue, VoidOrKeyHash, VoidOrKeyEqual</span><br><span class="line">         , BucketTraits</span><br><span class="line">         , <span class="number">0</span> != (BoolFlags &amp; hash_bool_flags::cache_begin_pos)</span><br><span class="line">         &gt;   <span class="comment">//2</span></span><br><span class="line">      , SizeType</span><br><span class="line">      , (BoolFlags &amp; hash_bool_flags::incremental_pos) != <span class="number">0</span></span><br><span class="line">      &gt; internal_type;;</span><br><span class="line">    [[no_unique_address]] internal_type size_traits_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>雖然還是又臭又長，不過已經改善不少</p>
<h4 id="Trap-on-no-unique-address"><a href="#Trap-on-no-unique-address" class="headerlink" title="Trap on [[no_unique_address]]"></a>Trap on [[no_unique_address]]</h4><p>以下的程式碼會是如何</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">empty</span> &#123;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">non_empty</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        [[no_unique_address]] empty e;</span><br><span class="line">        [[no_unique_address]] empty e1;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"%ld\n"</span>, <span class="keyword">sizeof</span>(struct non_empty));</span><br></pre></td></tr></table></figure>
<p>答案當然不是4，e和e1是同一個type，為了區分，不所以只能有一個有[[no_unique_address]]的屬性<br>要修掉這問題也很簡單</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">int</span>&gt;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">empty</span> &#123;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">non_empty</span> &#123;</span></span><br><span class="line">        <span class="keyword">int</span> v;</span><br><span class="line">        [[no_unique_address]] empty&lt;<span class="number">0</span>&gt; e;</span><br><span class="line">        [[no_unique_address]] empty&lt;<span class="number">1</span>&gt; e1;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="Another-issue-on-no-unique-address"><a href="#Another-issue-on-no-unique-address" class="headerlink" title="Another issue on [[no_unique_address]]"></a>Another issue on [[no_unique_address]]</h4><p>目前[[no_unique_address]]在MSVC是沒效果的，會造成ABI Break</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/17/Introduction-to-asynchronous-programming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="HungMingWu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="第十三號艦隊">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/03/17/Introduction-to-asynchronous-programming/" class="post-title-link" itemprop="url">Introduction to asynchronous programming</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-03-17 20:14:02" itemprop="dateCreated datePublished" datetime="2021-03-17T20:14:02+00:00">2021-03-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-10-06 01:47:17" itemprop="dateModified" datetime="2025-10-06T01:47:17+00:00">2025-10-06</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Asynchronous-programming"><a href="#Asynchronous-programming" class="headerlink" title="Asynchronous programming"></a>Asynchronous programming</h1><h2 id="Why-asynchronous-programming"><a href="#Why-asynchronous-programming" class="headerlink" title="Why asynchronous programming"></a>Why asynchronous programming</h2><p>Asynchronous programming 是個反人類的思考的東西，就算選擇不同的程式語言，共識最好的Network programming model，都是這個樣子，一個connection一個thread</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">listen</span>(socket_fd, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Looooop */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">  newsocket_fd = accept(socket_fd, </span><br><span class="line">                          (struct sockaddr *) &amp;client_addr, </span><br><span class="line">                          &amp;client_len);</span><br><span class="line">  <span class="keyword">pthread_t</span> thread;</span><br><span class="line">  pthread_create(&amp;thread, <span class="literal">NULL</span>, run_thread, (<span class="keyword">void</span> *) newsocket_fd);</span><br><span class="line">  pthread_join(thread, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這個Model可以解決95%的問題，不過人生最難的就是那個But，這個Programming Model不能Scale</p>
<h2 id="C10K-Problem-1999"><a href="#C10K-Problem-1999" class="headerlink" title="C10K Problem (1999)"></a>C10K Problem (1999)</h2><p>這就是著名的C10K Problem，是Operation System的問題，OS不能有跟Connection一樣多的Thread，就算可以，也會耗費大量的Memory，以及頻繁的Context Switch<br>山不轉路轉，於是出現了IO multiplexing技術，也就是大家熟知的select/poll/epoll</p>
<h2 id="The-early-stage-of-asynchronous-programming"><a href="#The-early-stage-of-asynchronous-programming" class="headerlink" title="The early stage of asynchronous programming"></a>The early stage of asynchronous programming</h2><p>一開始的asynchronous programming，就算是libuv，asio或是nodejs等，都需要一個callback當參數，寫著寫著就會變成這樣<br><img src="https://ithelp.ithome.com.tw/upload/images/20171221/20065504RIRldpL7Fs.jpg" alt=""></p>
<h3 id="The-problem-of-callback"><a href="#The-problem-of-callback" class="headerlink" title="The problem of callback"></a>The problem of callback</h3><ul>
<li>反人類</li>
</ul>
<p>Thread based solution之所以被推崇，就是人類的思考模式傾向於直線思考，而Callback based solution需要將步驟切得七零八落，慘不忍睹</p>
<ul>
<li>難寫易錯</li>
</ul>
<p>假設事務夠簡單，一兩層callback就能解決的話，事情還好辦，當邏輯複雜到一個程度，寫錯的機率實在是太高了</p>
<p>Source Code是要寫給人看的，因此需要有工具來管理複雜度，也就是Coroutine</p>
<h3 id="System-Language對於Coroutine的態度"><a href="#System-Language對於Coroutine的態度" class="headerlink" title="System Language對於Coroutine的態度"></a>System Language對於Coroutine的態度</h3><ul>
<li>C：不關我的事，你自己想辦法</li>
<li>C++： 到了2021年還沒有標準的Network Library：會不會太落後</li>
<li>Rust： 比C++早訂定標準：不過押寶押錯了：標準也定了：改不了了：至於押寶押錯這件事後面再說</li>
</ul>
<h3 id="What-is-coroutine"><a href="#What-is-coroutine" class="headerlink" title="What is coroutine"></a>What is coroutine</h3><p>太陽底下沒有新鮮事，Coroutine在1963年就被提出，過了五十年後重新被人想起<br>Coroutine擁有以下四種特性</p>
<ul>
<li>Invoke</li>
<li>Return</li>
<li>Yield </li>
<li>Resume</li>
</ul>
<p>而我們一般所知道的Function就只有</p>
<ul>
<li>Invoke</li>
<li>Return</li>
</ul>
<p>也就是Function只是Coroutine的特殊案例</p>
<p>Coroutine的另一項特性</p>
<ul>
<li>Cooperative multitasking</li>
</ul>
<p>同樣的，太陽底下沒有新鮮事<br>聽過當初Windows 3.1常常會程式卡死，而Windows 95不會，就是因為將<code>Cooperative multitasking</code>改成<code>Pre-emptive multitasking</code></p>
<h4 id="The-simplest-example-on-coroutine"><a href="#The-simplest-example-on-coroutine" class="headerlink" title="The simplest example on coroutine"></a>The simplest example on coroutine</h4><p>雖然這範例沒什麼用，不過能夠讓我們了解Corotuine的本質，能夠Yield和Resume<br>switch的case可以包含在for loop迴圈裡面，不過蔗不是本文重點</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">counter</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i, state = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">switch</span> (state) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="comment">/* start of function */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            state = <span class="number">1</span>; <span class="comment">/* so we will come back to "case 1" */</span></span><br><span class="line">            <span class="keyword">return</span> i;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:; <span class="comment">/* resume control straight after the return */</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, counter());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面這個只是個玩具Coroutine，真正能拿來用的還分幾類<br>至於怎麼做就各顯神通了</p>
<ul>
<li><a href="https://probablydance.com/2012/11/18/implementing-coroutines-with-ucontext/" target="_blank" rel="noopener">Implementing coroutines with ucontext</a></li>
<li><a href="https://gist.github.com/aprell/1951574" target="_blank" rel="noopener">Switching between coroutines/tasks: setjmp/longjmp (single stack)</a></li>
<li><a href="http://www.softpanorama.org/Lang/Asmorama/coroutines_in_assembler.shtml" target="_blank" rel="noopener">Coroutines in Assembler</a></li>
</ul>
<h4 id="Two-difference-model-on-Coroutine"><a href="#Two-difference-model-on-Coroutine" class="headerlink" title="Two difference model on Coroutine"></a>Two difference model on Coroutine</h4><p>就算是Coroutine，也可以分成兩類</p>
<ul>
<li>Stackful Coroutine</li>
<li>Stackless Coroutine<br>顧名思義，差異就在對Stack的處理上面</li>
<li>Stackless將State放在Heap上，而Stackful放在Stack上</li>
<li>Stackless的大小是動態分配的，Stackful的Stack是固定大小的</li>
<li>Stackless本質是個StateMachine，而Stackful是個User Mode Thread<br>因此Stackess Machine的Runtime消耗比較小，Stackful相反</li>
<li>Stackful可以和舊有的synchronous code組合，Stackless不行</li>
<li>Stackless需要Compilier支援，Stackful只需要Library就能做了</li>
<li>Stackless的方案有傳染性，例如你在Javascrupt所看到的<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> func1() &#123;</span><br><span class="line">  <span class="keyword">await</span> func2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
你的async/await是成雙成對的，布這麼用就會出錯，而Stackful沒有此限制</li>
<li>Stackful的程式好寫，Stackless需要一定能力</li>
</ul>
<h4 id="選邊站"><a href="#選邊站" class="headerlink" title="選邊站"></a>選邊站</h4><p>由於兩種Model差異很大，由於程式語言的特性以及歷史因素，不同程式語言的選擇也不一樣</p>
<ul>
<li>Stackless：C#(第一個使用async/await的主流語言)，Javascript，Python，C++，Rust，Kotlin(雖然是JVM的語言，不過跟Java選擇不同)</li>
<li>Stackful：Golang(其實是變種的Coroutine)，Java(照抄Golang那套，不過還沒推出)，PHP(in the future)</li>
</ul>
<h4 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h4><p>前面提到，Goroutine是Stackful Coroutine的變形，最主要的差異在於</p>
<ul>
<li>coroutine是順序執行</li>
<li>Goroutine可以在多個cpu平行執行的<br>因此又產生了分歧點<br>假設我們有Coroutine A，B，C<br>C等待B的資料，B等待A的資料</li>
<li>如果是傳統的Coroutine，A執行完會transfer到B，B執行完會transfer到C，由於在同一個CPU上，資料不用加鎖</li>
<li>如果是Goroutine，A，B，C三者可能在不同的CPU上跑，關於資料的傳遞只能透過Channel</li>
<li>由於Golang實作了一個有效利用Cpu Usage的Runtime，將corotuine定義成light weight thread，所以Golang Runtime需要做一部分OS需要做的事情，例如Schedule coroutine</li>
<li>Mandatory goroutine，就算你寫一個hello world也避不掉</li>
<li>Goroutine不快，Maximum network connection也比不上Stackless Coroutine(C++/Rust)</li>
<li>不過程式好寫太多，這強項才是goroutine搶走PHP/Python的主要原因</li>
</ul>
<h3 id="押錯寶"><a href="#押錯寶" class="headerlink" title="押錯寶"></a>押錯寶</h3><p>講講Rust押寶押錯的故事</p>
<h4 id="IO-Model有兩種"><a href="#IO-Model有兩種" class="headerlink" title="IO Model有兩種"></a>IO Model有兩種</h4><p>如同Coroutine有兩種，IO EventLoop也有兩種</p>
<ul>
<li>Proactor：最著名的就是Windows的IOCP了</li>
<li>Reactor：select/poll/epoll等都是<br>Rust使用epoll的Reactor Model，不過epoll不是linux的未來</li>
</ul>
<h4 id="CPU-Spectre-and-Meltdown"><a href="#CPU-Spectre-and-Meltdown" class="headerlink" title="CPU Spectre and Meltdown"></a>CPU Spectre and Meltdown</h4><p>就跟COVID-19一樣，Spectre和Meltdown改變了寫程式的方向<br>因為CPU的Bug，Linux修正方向，<code>io_uring</code>才是Linux的未來，而io_uring和IOCP一樣，是Proactor的model</p>
<h4 id="Influence"><a href="#Influence" class="headerlink" title="Influence"></a>Influence</h4><p>由於標準定了，要改改不了了<br>如果要改的話只有兩種選擇</p>
<ul>
<li>重新制定標準，然後變成v2版本，光是制定一個版本花了四年，這次應該會快一點</li>
<li>兩個Model是可以互轉的，只是會有Performance Loss，當Spectre和Meltdown的Patch打上去之後會掉多少更難以估計</li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><ul>
<li>如果你是那95%的人，根本用不上Asynchronous programming，直接使用thread model，還不容易錯</li>
<li>如果不幸是那5%的人，首先考慮golang，golang就算幾千個缺點，goroutine都能掩蓋過去<br>golang適合寫網路服務，也只能寫網路服務</li>
<li>如果你是一秒鐘幾千萬上下，出來跑得遲早都要還，逃不掉C/C++/Rust寫code了<br>這裡有個實際案例<br><a href="https://blog.discord.com/why-discord-is-switching-from-go-to-rust-a190bbca2b1f" target="_blank" rel="noopener">Why Discord is switching from Go to Rust</a></li>
<li>沒有最好的方案，只有適合的方案</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          
<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">HungMingWu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">258</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">HungMingWu</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
